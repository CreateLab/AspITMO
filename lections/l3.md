# –õ–µ–∫—Ü–∏—è 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Ä–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ ASP.NET Core

**–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 60-75 –º–∏–Ω—É—Ç  
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫:** ASP.NET Core 8.0, PostgreSQL 16, Entity Framework Core, FluentMigrator  
**–î–∞—Ç–∞:** 2025

---

## 1. –í–≤–µ–¥–µ–Ω–∏–µ (3 –º–∏–Ω—É—Ç—ã)

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –≤—Ç–æ—Ä—É—é –ª–µ–∫—Ü–∏—é –Ω–∞—à–µ–≥–æ –∫—É—Ä—Å–∞! –°–µ–≥–æ–¥–Ω—è –º—ã –ø–æ–≥—Ä—É–∑–∏–º—Å—è –≤ –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ enterprise-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π - –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ —Ä–∞–±–æ—Ç—É —Å –¥–∞–Ω–Ω—ã–º–∏.

### –ü–æ—á–µ–º—É —ç—Ç–∞ —Ç–µ–º–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞?

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã —Å—Ç—Ä–æ–∏—Ç–µ –¥–æ–º. –ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å –ø—Ä–æ—á–Ω–æ–≥–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞ –∏ —á–µ—Ç–∫–æ–≥–æ –ø–ª–∞–Ω–∞, –∏–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–∞—Ç—å –∫–ª–∞—Å—Ç—å –∫–∏—Ä–ø–∏—á–∏, –Ω–∞–¥–µ—è—Å—å, —á—Ç–æ –≤—Å–µ –ø–æ–ª—É—á–∏—Ç—Å—è —Å–∞–º–æ —Å–æ–±–æ–π. –í –ø–µ—Ä–≤–æ–º —Å–ª—É—á–∞–µ –¥–æ–º –ø—Ä–æ—Å—Ç–æ–∏—Ç –¥–µ—Å—è—Ç–∏–ª–µ—Ç–∏—è–º–∏, –≤–æ –≤—Ç–æ—Ä–æ–º - –º–æ–∂–µ—Ç —Ä—É—Ö–Ω—É—Ç—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∂–µ –±—É—Ä–µ. –ê–±—Å–æ–ª—é—Ç–Ω–æ —Ç–æ –∂–µ —Å–∞–º–æ–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏.

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç –∑–∞ —Å–µ–±—è:**
- 70% legacy-–ø—Ä–æ–µ–∫—Ç–æ–≤ –∏–º–µ—é—Ç –ø—Ä–æ–±–ª–µ–º—ã –∏–º–µ–Ω–Ω–æ —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- 50% –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —É—Ö–æ–¥–∏—Ç –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –æ—à–∏–±–æ–∫
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ —ç–∫–æ–Ω–æ–º–∏—Ç –º–µ—Å—è—Ü—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ß—Ç–æ –º—ã –∏–∑—É—á–∏–º —Å–µ–≥–æ–¥–Ω—è

**–ß–∞—Å—Ç—å 1: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ASP.NET Core –∏ –µ—ë –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- Options Pattern –¥–ª—è strongly-typed –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ (User Secrets, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)

**–ß–∞—Å—Ç—å 2: Dependency Injection**
- –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–µ—Ä–≤–∏—Å–æ–≤: Singleton, Scoped, Transient
- –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏ —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

**–ß–∞—Å—Ç—å 3: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã**
- N-Layer Architecture: –ø—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- Clean Architecture: enterprise-—Ä–µ—à–µ–Ω–∏–µ —Å –∏–Ω–≤–µ—Ä—Å–∏–µ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –≤—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ

**–ß–∞—Å—Ç—å 4: –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏**
- PostgreSQL –≤ Docker (–±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- Entity Framework Core: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞, DbContext, —Å–≤—è–∑–∏
- DbContext Factory –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- FluentMigrator: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

**–ß–∞—Å—Ç—å 5: –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º**
- –ü–æ—á–µ–º—É Generic Repository - –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω
- –ö–æ–≥–¥–∞ –∏ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Specific Repository
- Unit of Work –ø–∞—Ç—Ç–µ—Ä–Ω: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### –°–≤—è–∑—å —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ª–µ–∫—Ü–∏–µ–π

–ù–∞ –ø—Ä–æ—à–ª–æ–π –ª–µ–∫—Ü–∏–∏ –º—ã —Å–æ–∑–¥–∞–ª–∏ –ø—Ä–æ—Å—Ç–æ–µ ASP.NET Core –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏, routing –∏ –æ—Å–Ω–æ–≤–∞–º–∏ Minimal API. –°–µ–≥–æ–¥–Ω—è –º—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏–º —ç—Ç–æ –≤ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –≥–æ—Ç–æ–≤–æ–µ –∫ enterprise-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.

---

## 2. Configuration –≤ ASP.NET Core (10 –º–∏–Ω—É—Ç)

### 2.1 –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

ASP.NET Core –∏–º–µ–µ—Ç –º–æ—â–Ω—É—é –∏ –≥–∏–±–∫—É—é —Å–∏—Å—Ç–µ–º—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤. –≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —á—Ç–µ–Ω–∏–µ JSON-—Ñ–∞–π–ª–∞ - —ç—Ç–æ —Ü–µ–ª–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏.

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–≤ –ø–æ—Ä—è–¥–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏):**

1. **appsettings.json** - –±–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. **appsettings.{Environment}.json** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. **User Secrets** - –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (—Ç–æ–ª—å–∫–æ Development)
4. **Environment Variables** - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –û–°
5. **Command-line Arguments** - –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞!**

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–ª–æ—è–º–∏, –≥–¥–µ –∫–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫ **–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç** –ø—Ä–µ–¥—ã–¥—É—â–∏–π:

```
[Lowest Priority]
1. appsettings.json                    ‚Üê –ë–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
2. appsettings.{Environment}.json      ‚Üê –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç #1
3. User Secrets (—Ç–æ–ª—å–∫–æ Dev)           ‚Üê –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç #1-2
4. Environment Variables                ‚Üê –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç #1-3
5. Command-line Arguments               ‚Üê –ù–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
[Highest Priority]
```

**–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä:**

–î–æ–ø—É—Å—Ç–∏–º, –≤ `appsettings.json` —É –≤–∞—Å:
```json
"Logging": { "LogLevel": { "Default": "Information" } }
```

–ê –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
Logging__LogLevel__Default=Debug
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è `Debug`, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–º–µ—é—Ç –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.

### 2.2 –†–∞–±–æ—Ç–∞ —Å appsettings.json

–°–æ–∑–¥–∞–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Information"
    }
  },
  "AllowedHosts": "*",
  
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=myappdb;Username=postgres;Password=postgres",
    "RedisConnection": "localhost:6379"
  },
  
  "AppSettings": {
    "ApplicationName": "MyAwesomeApp",
    "ApplicationVersion": "1.0.0",
    "MaxItemsPerPage": 50,
    "CacheExpirationMinutes": 30,
    "EnableCache": true,
    "AllowedOrigins": [
      "https://localhost:5001",
      "https://example.com"
    ]
  },
  
  "Email": {
    "SmtpServer": "smtp.gmail.com",
    "SmtpPort": 587,
    "SenderEmail": "noreply@myapp.com",
    "SenderName": "My App",
    "EnableSsl": true
  },
  
  "Jwt": {
    "Secret": "NEVER_PUT_SECRETS_IN_APPSETTINGS",
    "Issuer": "MyApp",
    "Audience": "MyAppUsers",
    "ExpirationMinutes": 60
  }
}
```

**–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è:**

‚úÖ –ì—Ä—É–ø–ø–∏—Ä—É–π—Ç–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Å–µ–∫—Ü–∏–∏  
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–µ, —Å–∞–º–æ–æ–ø–∏—Å—ã–≤–∞—é—â–∏–µ—Å—è –∏–º–µ–Ω–∞  
‚úÖ –î–æ–±–∞–≤–ª—è–π—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤  
‚ùå –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã (–ø–∞—Ä–æ–ª–∏, API –∫–ª—é—á–∏) –≤ appsettings.json  

**–ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –∫–æ–¥–µ:**

```csharp
public class ProductsController : ControllerBase
{
    private readonly IConfiguration _configuration;
    private readonly ILogger<ProductsController> _logger;
    
    public ProductsController(IConfiguration configuration, ILogger<ProductsController> logger)
    {
        _configuration = configuration;
        _logger = logger;
    }
    
    [HttpGet]
    public IActionResult GetSettings()
    {
        // –ß—Ç–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
        var appName = _configuration["AppSettings:ApplicationName"];
        
        // –ß—Ç–µ–Ω–∏–µ —Å –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        var maxItems = _configuration.GetValue<int>("AppSettings:MaxItemsPerPage", 20);
        
        // –ß—Ç–µ–Ω–∏–µ connection string
        var connString = _configuration.GetConnectionString("DefaultConnection");
        
        // –ß—Ç–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞
        var allowedOrigins = _configuration.GetSection("AppSettings:AllowedOrigins")
            .Get<string[]>();
        
        // –ß—Ç–µ–Ω–∏–µ –≤—Å–µ–π —Å–µ–∫—Ü–∏–∏
        var emailSection = _configuration.GetSection("Email");
        var smtpServer = emailSection["SmtpServer"];
        var smtpPort = emailSection.GetValue<int>("SmtpPort");
        
        _logger.LogInformation("App: {AppName}, Max Items: {MaxItems}", appName, maxItems);
        
        return Ok(new { appName, maxItems, smtpServer });
    }
}
```

### 2.3 –û–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

ASP.NET Core –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `ASPNETCORE_ENVIRONMENT`:

- **Development** - —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ—à–∏–±–∫–∏)
- **Staging** - –ø—Ä–µ–¥–ø—Ä–æ–¥–∞–∫—à–Ω (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—ã–∫–∞—Ç–∫–æ–π)
- **Production** - –ø—Ä–æ–¥–∞–∫—à–Ω (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)

**appsettings.Development.json:**
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft": "Debug"
    }
  },
  "AppSettings": {
    "EnableCache": false,
    "EnableDetailedErrors": true
  },
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Database=myapp_dev;Username=dev;Password=dev123"
  }
}
```

**appsettings.Production.json:**
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft": "Error"
    }
  },
  "AppSettings": {
    "EnableCache": true,
    "EnableDetailedErrors": false
  }
  // Connection string –±—É–¥–µ—Ç –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –∫–æ–¥–µ:**

```csharp
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
    app.UseSwagger();
    app.UseSwaggerUI();
}
else
{
    app.UseExceptionHandler("/Error");
    app.UseHsts();
}

app.Run();
```

### 2.4 Options Pattern - Strongly-Typed Configuration

–†–∞–±–æ—Ç–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ —Å—Ç—Ä–æ–∫–∏ –∏–º–µ–µ—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- ‚ùå –ù–µ—Ç IntelliSense –∏ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚ùå –õ–µ–≥–∫–æ –¥–æ–ø—É—Å—Ç–∏—Ç—å –æ–ø–µ—á–∞—Ç–∫—É
- ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- ‚ùå –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω

**Options Pattern —Ä–µ—à–∞–µ—Ç –≤—Å–µ —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã!**

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–∫

```csharp
// AppSettings.cs
public class AppSettings
{
    public const string SectionName = "AppSettings";
    
    public string ApplicationName { get; set; } = string.Empty;
    public string ApplicationVersion { get; set; } = string.Empty;
    public int MaxItemsPerPage { get; set; } = 20;
    public int CacheExpirationMinutes { get; set; } = 30;
    public bool EnableCache { get; set; } = true;
    public string[] AllowedOrigins { get; set; } = Array.Empty<string>();
}

// EmailSettings.cs
public class EmailSettings
{
    public const string SectionName = "Email";
    
    public string SmtpServer { get; set; } = string.Empty;
    public int SmtpPort { get; set; } = 587;
    public string SenderEmail { get; set; } = string.Empty;
    public string SenderName { get; set; } = string.Empty;
    public bool EnableSsl { get; set; } = true;
}

// JwtSettings.cs
public class JwtSettings
{
    public const string SectionName = "Jwt";
    
    public string Secret { get; set; } = string.Empty;
    public string Issuer { get; set; } = string.Empty;
    public string Audience { get; set; } = string.Empty;
    public int ExpirationMinutes { get; set; } = 60;
}
```

#### –®–∞–≥ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Program.cs

```csharp
var builder = WebApplication.CreateBuilder(args);

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Options
builder.Services.Configure<AppSettings>(
    builder.Configuration.GetSection(AppSettings.SectionName));

builder.Services.Configure<EmailSettings>(
    builder.Configuration.GetSection(EmailSettings.SectionName));

builder.Services.Configure<JwtSettings>(
    builder.Configuration.GetSection(JwtSettings.SectionName));

// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (.NET 8+)
builder.Services.AddOptionsWithValidateOnStart<AppSettings>()
    .Bind(builder.Configuration.GetSection(AppSettings.SectionName))
    .ValidateDataAnnotations()
    .Validate(settings => 
    {
        if (settings.MaxItemsPerPage > 1000)
        {
            return false;
        }
        return true;
    }, "MaxItemsPerPage –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ 1000");
```

#### –®–∞–≥ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

```csharp
public class ProductService
{
    private readonly AppSettings _appSettings;
    private readonly EmailSettings _emailSettings;
    private readonly ILogger<ProductService> _logger;
    
    // IOptions<T> - –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –º–µ–Ω—è—é—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
    public ProductService(
        IOptions<AppSettings> appSettings,
        IOptions<EmailSettings> emailSettings,
        ILogger<ProductService> logger)
    {
        _appSettings = appSettings.Value;
        _emailSettings = emailSettings.Value;
        _logger = logger;
    }
    
    public async Task<PagedResult<Product>> GetProductsAsync(int page)
    {
        _logger.LogInformation(
            "Getting products, page: {Page}, items per page: {ItemsPerPage}",
            page, _appSettings.MaxItemsPerPage);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É
        var pageSize = _appSettings.MaxItemsPerPage;
        
        // –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞...
        
        return new PagedResult<Product>
        {
            Items = products,
            PageSize = pageSize,
            CurrentPage = page
        };
    }
}
```

### 2.5 –¢—Ä–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Options: –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫–æ–π

**1. IOptions\<T\> - Singleton**
```csharp
public class MyService
{
    private readonly AppSettings _settings;
    
    public MyService(IOptions<AppSettings> options)
    {
        _settings = options.Value; // –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –û–î–ò–ù —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    }
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –°–∞–º—ã–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
- ‚úÖ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è 90% —Å–ª—É—á–∞–µ–≤

**2. IOptionsSnapshot\<T\> - Scoped**
```csharp
public class RequestScopedService
{
    private readonly IOptionsSnapshot<AppSettings> _settingsSnapshot;
    
    public RequestScopedService(IOptionsSnapshot<AppSettings> settingsSnapshot)
    {
        _settingsSnapshot = settingsSnapshot;
    }
    
    public void DoWork()
    {
        // –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º HTTP-–∑–∞–ø—Ä–æ—Å–µ
        var currentSettings = _settingsSnapshot.Value;
    }
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –ù—É–∂–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Scoped –∏ Transient —Å–µ—Ä–≤–∏—Å–∞—Ö
- ‚ùå –ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ Singleton!

**3. IOptionsMonitor\<T\> - Singleton —Å hot-reload**
```csharp
public class CacheService
{
    private readonly IOptionsMonitor<AppSettings> _settingsMonitor;
    private IDisposable? _changeSubscription;
    
    public CacheService(IOptionsMonitor<AppSettings> settingsMonitor)
    {
        _settingsMonitor = settingsMonitor;
        
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        _changeSubscription = _settingsMonitor.OnChange(settings =>
        {
            Console.WriteLine($"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å! –ù–æ–≤–æ–µ –≤—Ä–µ–º—è –∫—ç—à–∞: {settings.CacheExpirationMinutes}");
            // –ú–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à, –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ-—Ç–æ –∏ —Ç.–¥.
        });
    }
    
    public void DoWork()
    {
        // –í—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        var currentSettings = _settingsMonitor.CurrentValue;
        
        // –†–∞–±–æ—Ç–∞–µ–º —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏...
    }
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –ù—É–∂–µ–Ω hot-reload –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ Singleton
- ‚ö†Ô∏è –ë–æ–ª—å—à–µ overhead, —á–µ–º IOptions

**–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞:**

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | IOptions<T> | IOptionsSnapshot<T> | IOptionsMonitor<T> |
|---------------|-------------|---------------------|-------------------|
| Lifetime | Singleton | Scoped | Singleton |
| –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–Ω–∏–µ | –ù–∏–∫–æ–≥–¥–∞ | –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å | Real-time |
| OnChange | ‚ùå | ‚ùå | ‚úÖ |
| Performance | ‚ö°‚ö°‚ö° | ‚ö°‚ö° | ‚ö° |
| Use case | 90% —Å–ª—É—á–∞–µ–≤ | –ò–∑–º–µ–Ω—è–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥ | Hot-reload |

---

## 3. Connection Strings –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ (7 –º–∏–Ω—É—Ç)

### 3.1 Connection Strings –¥–ª—è PostgreSQL

Connection string - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç –æ—Å–æ–±–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Connection String –¥–ª—è PostgreSQL:**

```
Host=localhost;Port=5432;Database=myappdb;Username=postgres;Password=mypassword;
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|----------|----------|--------|
| `Host` | –ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –ë–î | `localhost`, `db.example.com`, `192.168.1.100` |
| `Port` | –ü–æ—Ä—Ç PostgreSQL | `5432` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| `Database` | –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö | `myappdb`, `production_db` |
| `Username` | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | `postgres`, `app_user` |
| `Password` | –ü–∞—Ä–æ–ª—å | `mypassword` (–ù–ò–ö–û–ì–î–ê –≤ Git!) |

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

```
Host=localhost;
Port=5432;
Database=myappdb;
Username=postgres;
Password=mypassword;

// Connection Pooling (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)
Pooling=true;
Minimum Pool Size=0;
Maximum Pool Size=100;
Connection Lifetime=0;

// –¢–∞–π–º–∞—É—Ç—ã
Timeout=30;
Command Timeout=30;

// SSL (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è production!)
SSL Mode=Require;
Trust Server Certificate=false;

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
Encoding=UTF8;
Application Name=MyApp;
```

**–ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π:**

```json
// Development
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Database=myapp_dev;Username=postgres;Password=postgres"
  }
}

// Staging
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=staging-db.internal;Database=myapp_staging;Username=app_user;Password=STORED_IN_ENV_VAR;SSL Mode=Require"
  }
}

// Production - –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!
{
  "ConnectionStrings": {
    "DefaultConnection": "SET_VIA_ENVIRONMENT_VARIABLE"
  }
}
```

### 3.2 –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤

**üö® –ó–û–õ–û–¢–û–ï –ü–†–ê–í–ò–õ–û –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:**

**–ù–ò–ö–û–ì–î–ê –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –≤ Git:**
- –ü–∞—Ä–æ–ª–∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
- API –∫–ª—é—á–∏
- –¢–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞
- –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏
- –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Å–µ–∫—Ä–µ—Ç—ã

#### 3.2.1 User Secrets - –¥–ª—è Development

User Secrets - —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ **–ª–æ–∫–∞–ª—å–Ω–æ** –Ω–∞ –º–∞—à–∏–Ω–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞, **–≤–Ω–µ** –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞.

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è User Secrets:**

```bash
# 1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd MyApp.WebApi

# 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ User Secrets
dotnet user-secrets init

# –≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç –≤ .csproj:
# <UserSecretsId>—É–Ω–∏–∫–∞–ª—å–Ω—ã–π-guid-12345</UserSecretsId>
```

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤:**

```bash
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ connection string
dotnet user-secrets set "ConnectionStrings:DefaultConnection" \
  "Host=localhost;Database=myapp;Username=postgres;Password=my_secret_dev_password"

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–∞
dotnet user-secrets set "Email:ApiKey" "SG.secret_sendgrid_api_key_12345"

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ JWT secret
dotnet user-secrets set "Jwt:Secret" "super-secret-jwt-signing-key-min-32-chars"

# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
dotnet user-secrets list

# –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞
dotnet user-secrets remove "Email:ApiKey"

# –û—á–∏—Å—Ç–∫–∞ –í–°–ï–• —Å–µ–∫—Ä–µ—Ç–æ–≤
dotnet user-secrets clear
```

**–ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è User Secrets?**

User Secrets —Ö—Ä–∞–Ω—è—Ç—Å—è **–í–ù–ï** –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:

```
# Windows
%APPDATA%\Microsoft\UserSecrets\<user_secrets_id>\secrets.json

# Linux / macOS
~/.microsoft/usersecrets/<user_secrets_id>/secrets.json
```

**–ü—Ä–∏–º–µ—Ä secrets.json:**
```json
{
  "ConnectionStrings:DefaultConnection": "Host=localhost;Database=myapp;Username=postgres;Password=my_secret",
  "Email:ApiKey": "SG.api_key_here",
  "Jwt:Secret": "super-secret-key-32-chars-min"
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ:**

User Secrets –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Development –æ–∫—Ä—É–∂–µ–Ω–∏–∏:

```csharp
var builder = WebApplication.CreateBuilder(args);

// –í Development —Å—Ä–µ–¥–µ User Secrets –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
// –∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ appsettings.json

var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");
// –í Dev: –ø–æ–ª—É—á–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ User Secrets
// –í Prod: –ø–æ–ª—É—á–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseNpgsql(connectionString));
```

#### 3.2.2 Environment Variables - –¥–ª—è Production

–í production **–≤—Å–µ–≥–¥–∞** –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤.

**–í–∞–∂–Ω–æ:** –í –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ `:` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `__` (–¥–≤–æ–π–Ω–æ–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)

```bash
# JSON –ø—É—Ç—å: ConnectionStrings:DefaultConnection
# Env –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: ConnectionStrings__DefaultConnection

# JSON –ø—É—Ç—å: Jwt:Secret
# Env –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: Jwt__Secret

# JSON –ø—É—Ç—å: AppSettings:Email:ApiKey
# Env –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: AppSettings__Email__ApiKey
```

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:**

**Linux/macOS:**
```bash
# –í—Ä–µ–º–µ–Ω–Ω–∞—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏)
export ConnectionStrings__DefaultConnection="Host=prod-db.com;Database=myapp;Username=app;Password=secret;SSL Mode=Require"

# –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è (–¥–æ–±–∞–≤–∏—Ç—å –≤ ~/.bashrc –∏–ª–∏ ~/.zshrc)
echo 'export ConnectionStrings__DefaultConnection="..."' >> ~/.bashrc
```

**Windows (PowerShell):**
```powershell
# –í—Ä–µ–º–µ–Ω–Ω–∞—è
$env:ConnectionStrings__DefaultConnection="Host=prod-db.com;..."

# –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è (System)
[System.Environment]::SetEnvironmentVariable("ConnectionStrings__DefaultConnection", "...", "Machine")
```

**Docker:**
```yaml
version: '3.8'
services:
  webapp:
    image: myapp:latest
    environment:
      - ConnectionStrings__DefaultConnection=Host=db;Database=myapp;Username=app;Password=${DB_PASSWORD}
      - Jwt__Secret=${JWT_SECRET}
      - ASPNETCORE_ENVIRONMENT=Production
    env_file:
      - .env.production
```

**Kubernetes:**
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: myapp-secrets
type: Opaque
data:
  connection-string: <base64-encoded-value>
  jwt-secret: <base64-encoded-value>

---
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
spec:
  containers:
  - name: myapp
    image: myapp:latest
    env:
    - name: ConnectionStrings__DefaultConnection
      valueFrom:
        secretKeyRef:
          name: myapp-secrets
          key: connection-string
```

#### 3.2.3 –û–±–ª–∞—á–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤

–î–ª—è enterprise-—Ä–µ—à–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:

**Azure Key Vault:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞
dotnet add package Azure.Extensions.AspNetCore.Configuration.Secrets

# –í Program.cs
var builder = WebApplication.CreateBuilder(args);

if (!builder.Environment.IsDevelopment())
{
    var keyVaultEndpoint = new Uri(builder.Configuration["KeyVaultEndpoint"]!);
    builder.Configuration.AddAzureKeyVault(keyVaultEndpoint, new DefaultAzureCredential());
}
```

**AWS Secrets Manager:**
```bash
dotnet add package AWSSDK.SecretsManager
dotnet add package AWSSDK.Extensions.NETCore.Setup

# –í Program.cs
builder.Configuration.AddSecretsManager(configurator: options =>
{
    options.SecretFilter = entry => entry.Name.StartsWith("myapp/");
    options.KeyGenerator = (entry, key) => key.Replace("__", ":");
});
```

#### 3.2.4 .gitignore - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.gitignore` –µ—Å—Ç—å:

```gitignore
# User secrets
**/secrets.json
**/appsettings.*.json
!**/appsettings.Development.json.example

# Environment files
.env
.env.local
.env.production
.env.*.local

# Sensitive configuration
**/connectionstrings.json
**/secrets/

# IDE
.vs/
.vscode/
.idea/
*.user
*.suo
```

### 3.3 –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

‚úÖ **DO:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ User Secrets –≤ Development
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Production
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±–ª–∞—á–Ω—ã–µ Key Vault –¥–ª—è enterprise
- –†–æ—Ç–∏—Ä—É–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –¥–ª—è –ë–î —é–∑–µ—Ä–æ–≤

‚ùå **DON'T:**
- –ö–æ–º–º–∏—Ç–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ Git
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
- –•—Ä–∞–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ appsettings.json
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –ø–æ –Ω–µ–∑–∞—â–∏—â–µ–Ω–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º

---

## 4. PostgreSQL –≤ Docker (5 –º–∏–Ω—É—Ç)

–ü—Ä–µ–∂–¥–µ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, –Ω–∞–º –Ω—É–∂–Ω–∞ —Å–∞–º–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö. –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker.

### 4.1 –ó–∞—á–µ–º Docker –¥–ª—è –ë–î –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ?

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å PostgreSQL –Ω–∞ —Å–≤–æ—é –º–∞—à–∏–Ω—É
- ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ë–î
- ‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ä–µ–¥–∞ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ë–î —É –≤—Å–µ–π –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ –õ–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –ø—Ä–æ–µ–∫—Ç–∞–º–∏
- ‚úÖ –ü—Ä–æ—Å—Ç–æ–µ –≤–æ—Å—Å–æ–∑–¥–∞–Ω–∏–µ —Å –Ω—É–ª—è

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ—Ç –∫—É—Ä—Å –Ω–µ –ø—Ä–æ Docker. –ú—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞.

### 4.2 –ó–∞–ø—É—Å–∫ PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞ docker run**

```bash
# –ó–∞–ø—É—Å–∫ PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker run --name myapp-postgres \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=myappdb \
  -p 5432:5432 \
  -d postgres:16

# –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:
# --name myapp-postgres          ‚Üí –ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# -e POSTGRES_USER=postgres      ‚Üí –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î
# -e POSTGRES_PASSWORD=postgres  ‚Üí –ü–∞—Ä–æ–ª—å (–¥–ª—è dev –æ–∫—Ä—É–∂–µ–Ω–∏—è)
# -e POSTGRES_DB=myappdb         ‚Üí –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# -p 5432:5432                   ‚Üí –ü—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞ (host:container)
# -d                             ‚Üí –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (daemon)
# postgres:16                    ‚Üí –û–±—Ä–∞–∑ PostgreSQL –≤–µ—Ä—Å–∏–∏ 16
```

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker ps

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker stop myapp-postgres

# –ó–∞–ø—É—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker start myapp-postgres

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker restart myapp-postgres

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker logs myapp-postgres
docker logs -f myapp-postgres  # —Å–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

# –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–£–î–ê–õ–ò–¢ –í–°–ï –î–ê–ù–ù–´–ï!)
docker rm -f myapp-postgres
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: docker-compose.yml (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `docker-compose.yml` –≤ –∫–æ—Ä–Ω–µ —Ä–µ—à–µ–Ω–∏—è:

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:16
    container_name: myapp-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: myappdb
      # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.utf8"
    ports:
      - "5432:5432"
    volumes:
      # –î–∞–Ω–Ω—ã–µ –ë–î —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
      - postgres_data:/var/lib/postgresql/data
      # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–∫—Ä–∏–ø—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      # - ./init-scripts:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
    driver: local
```

**–ö–æ–º–∞–Ω–¥—ã docker-compose:**

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º volumes (–£–î–ê–õ–ò–¢ –í–°–ï –î–ê–ù–ù–´–ï!)
docker-compose down -v

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs postgres
docker-compose logs -f postgres  # —Å–ª–µ–¥–∏—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
docker-compose restart postgres

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker-compose up -d --force-recreate postgres
```

### 4.3 –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL

**–ò–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=myappdb;Username=postgres;Password=postgres"
  }
}
```

**–ß–µ—Ä–µ–∑ psql –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:**

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ psql –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker exec -it myapp-postgres psql -U postgres -d myappdb

# –¢–µ–ø–µ—Ä—å –≤—ã –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π PostgreSQL –∫–æ–Ω—Å–æ–ª–∏:
myappdb=# \dt                    -- –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
myappdb=# \d products            -- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã products
myappdb=# \l                     -- –°–ø–∏—Å–æ–∫ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
myappdb=# \du                    -- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
myappdb=# SELECT * FROM products; -- SQL –∑–∞–ø—Ä–æ—Å
myappdb=# \q                     -- –í—ã—Ö–æ–¥
```

**–ß–µ—Ä–µ–∑ GUI –∫–ª–∏–µ–Ω—Ç—ã:**

1. **pgAdmin** - https://www.pgadmin.org/
   - Host: `localhost`
   - Port: `5432`
   - Username: `postgres`
   - Password: `postgres`
   - Database: `myappdb`

2. **DBeaver** - https://dbeaver.io/
   - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ë–î
   - –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∏ open source

3. **DataGrip** - https://www.jetbrains.com/datagrip/
   - –û—Ç JetBrains
   - –ü–ª–∞—Ç–Ω—ã–π, –Ω–æ –º–æ—â–Ω—ã–π

### 4.4 –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã PostgreSQL

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
CREATE DATABASE myapp_test;

-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE USER app_user WITH PASSWORD 'secure_password';

-- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤
GRANT ALL PRIVILEGES ON DATABASE myappdb TO app_user;

-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
ALTER USER postgres WITH PASSWORD 'new_password';

-- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
-- (–≤—ã–ø–æ–ª–Ω—è—Ç—å –∏–∑ —Ö–æ—Å—Ç–∞, –Ω–µ –∏–∑ psql)
docker exec myapp-postgres pg_dump -U postgres myappdb > backup.sql

-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
docker exec -i myapp-postgres psql -U postgres myappdb < backup.sql
```

---

## 5. Dependency Injection –≤ ASP.NET Core (12 –º–∏–Ω—É—Ç)

Dependency Injection (DI) - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω, —ç—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å ASP.NET Core. –ü–æ–Ω–∏–º–∞–Ω–∏–µ DI –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã—Ö –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

### 5.1 –ß—Ç–æ —Ç–∞–∫–æ–µ Dependency Injection –∏ –∑–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω

**–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ DI:**

```csharp
// ‚ùå –ü–ª–æ—Ö–æ - –∂–µ—Å—Ç–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
public class OrderService
{
    private readonly EmailService _emailService;
    
    public OrderService()
    {
        _emailService = new EmailService(); // –°–æ–∑–¥–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Å–∞–º–∏
    }
    
    public void CreateOrder(Order order)
    {
        // –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞...
        _emailService.SendOrderConfirmation(order);
    }
}
```

**–ü—Ä–æ–±–ª–µ–º—ã —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å OrderService –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
- ‚ùå –ù–µ–ª—å–∑—è –ø–æ–¥–º–µ–Ω–∏—Ç—å EmailService –Ω–∞ mock
- ‚ùå OrderService –∑–Ω–∞–µ—Ç –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚ùå –°–ª–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é EmailService
- ‚ùå –ù–∞—Ä—É—à–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—Ü–∏–ø –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

**–†–µ—à–µ–Ω–∏–µ —Å DI:**

```csharp
// ‚úÖ –•–æ—Ä–æ—à–æ - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∏–Ω–∂–µ–∫—Ç–∏—Ç—Å—è
public interface IEmailService
{
    Task SendOrderConfirmation(Order order);
}

public class OrderService
{
    private readonly IEmailService _emailService;
    
    // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑–≤–Ω–µ (–∏–Ω–∂–µ–∫—Ç–∏—Ç—Å—è)
    public OrderService(IEmailService emailService)
    {
        _emailService = emailService;
    }
    
    public async Task CreateOrderAsync(Order order)
    {
        // –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞...
        await _emailService.SendOrderConfirmation(order);
    }
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ DI
builder.Services.AddScoped<IEmailService, EmailService>();
builder.Services.AddScoped<OrderService>();
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ DI:**
- ‚úÖ –°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å (loose coupling)
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å (–º–æ–∂–Ω–æ –ø–æ–¥–º–µ–Ω—è—Ç—å –Ω–∞ mocks)
- ‚úÖ –ò–Ω–≤–µ—Ä—Å–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—è (IoC)
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

### 5.2 –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ (Service Lifetimes)

ASP.NET Core DI container –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∏ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Å–µ—Ä–≤–∏—Å–æ–≤. –≠—Ç–æ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û** –ø–æ–Ω–∏–º–∞—Ç—å!

#### 5.2.1 Transient - –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑

```csharp
builder.Services.AddTransient<IEmailService, EmailService>();
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞–µ—Ç—Å—è **–ù–û–í–´–ô** —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏ **–ö–ê–ñ–î–û–ú** –∑–∞–ø—Ä–æ—Å–µ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- –ö–∞–∂–¥–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ = –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç
- –°–∞–º—ã–π –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–µ, stateless —Å–µ—Ä–≤–∏—Å—ã
- ‚úÖ –°–µ—Ä–≤–∏—Å—ã –±–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ –∫–ª–∞—Å—Å—ã (–≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã, –º–∞–ø–ø–µ, —Ö—ç—à–µ—Ä—ã)
- ‚úÖ –°–µ—Ä–≤–∏—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è

**–ü—Ä–∏–º–µ—Ä—ã:**
```csharp
builder.Services.AddTransient<IPasswordHasher, BcryptPasswordHasher>();
builder.Services.AddTransient<IEmailValidator, EmailValidator>();
builder.Services.AddTransient<IMapper, AutoMapper>();
```

**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**
```
HTTP Request 1:
  Controller ‚Üí Service A (new instance)
  Controller ‚Üí Service B (new instance)

HTTP Request 2:
  Controller ‚Üí Service A (new instance)
  Controller ‚Üí Service B (new instance)
```

#### 5.2.2 Scoped - –û–¥–∏–Ω –Ω–∞ HTTP-–∑–∞–ø—Ä–æ—Å

```csharp
builder.Services.AddScoped<IProductService, ProductService>();
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞–µ—Ç—Å—è **–û–î–ò–ù** —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ **HTTP-–∑–∞–ø—Ä–æ—Å** (scope)
- –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—É—á–∞—é—Ç –û–î–ò–ù –ò –¢–û–¢ –ñ–ï —ç–∫–∑–µ–º–ø–ª—è—Ä
- Dispose –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ –∑–∞–ø—Ä–æ—Å–∞

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ **DbContext** (–í–°–ï–ì–î–ê!)
- ‚úÖ Unit of Work
- ‚úÖ –°–µ—Ä–≤–∏—Å—ã, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å –ë–î –≤ —Ä–∞–º–∫–∞—Ö –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ –°–µ—Ä–≤–∏—Å—ã, —Ö—Ä–∞–Ω—è—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞

**–ü—Ä–∏–º–µ—Ä—ã:**
```csharp
builder.Services.AddScoped<ApplicationDbContext>();
builder.Services.AddScoped<IUnitOfWork, UnitOfWork>();
builder.Services.AddScoped<IProductRepository, ProductRepository>();
builder.Services.AddScoped<IOrderService, OrderService>();
```

**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**
```
HTTP Request 1:
  Controller ‚Üí Service A (instance #1)
  Repository ‚Üí Service A (SAME instance #1) ‚Üê –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ!
  
HTTP Request 2:
  Controller ‚Üí Service A (instance #2)
  Repository ‚Üí Service A (SAME instance #2)
```

#### 5.2.3 Singleton - –û–¥–∏–Ω –Ω–∞ –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```csharp
builder.Services.AddSingleton<ICacheService, MemoryCacheService>();
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞–µ—Ç—Å—è **–û–î–ò–ù** —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ **–í–°–Å** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- –ñ–∏–≤–µ—Ç –æ—Ç –∑–∞–ø—É—Å–∫–∞ –¥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- Dispose –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ shutdown

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (IOptions)
- ‚úÖ –õ–æ–≥–≥–µ—Ä—ã
- ‚úÖ –ö—ç—à (Memory Cache)
- ‚úÖ –î–æ—Ä–æ–≥–∏–µ –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å—ã
- ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω–æ —Ä–∞–∑–¥–µ–ª—è–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**‚ö†Ô∏è –í–ê–ñ–ù–û:** Singleton –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å thread-safe!

**–ü—Ä–∏–º–µ—Ä—ã:**
```csharp
builder.Services.AddSingleton<IMemoryCache, MemoryCache>();
builder.Services.AddSingleton<IConfiguration>(builder.Configuration);
builder.Services.AddSingleton<IHttpContextAccessor, HttpContextAccessor>();
```

**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**
```
HTTP Request 1:
  Controller ‚Üí Cache (singleton instance)
  
HTTP Request 2:
  Controller ‚Üí Cache (SAME singleton instance)
  
HTTP Request 3:
  Controller ‚Üí Cache (SAME singleton instance)
```

### 5.3 –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ Lifetimes

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | Transient | Scoped | Singleton |
|---------------|-----------|--------|-----------|
| **–°–æ–∑–¥–∞–Ω–∏–µ** | –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ | –ü—Ä–∏ –∫–∞–∂–¥–æ–º HTTP-–∑–∞–ø—Ä–æ—Å–µ | –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| **–ñ–∏–≤–µ—Ç** | –î–æ Dispose | –î–æ –∫–æ–Ω—Ü–∞ HTTP-–∑–∞–ø—Ä–æ—Å–∞ | –î–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| **–û–¥–∏–Ω–∞–∫–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä** | –ù–∏–∫–æ–≥–¥–∞ | –í —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ | –í—Å–µ–≥–¥–∞ |
| **Thread-safe** | –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è | –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è | **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!** |
| **–ü–∞–º—è—Ç—å** | –ú–∏–Ω–∏–º—É–º | –°—Ä–µ–¥–Ω–µ | –ú–æ–∂–µ—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è |
| **Performance** | ‚ö° | ‚ö°‚ö° | ‚ö°‚ö°‚ö° |
| **–¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏** | Validators, Mappers | DbContext, Repositories | Cache, Config, Loggers |

### 5.4 –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ Lifetimes

**üö® –ó–æ–ª–æ—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ:**

> –°–µ—Ä–≤–∏—Å –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –¢–û–õ–¨–ö–û –æ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –¢–ê–ö–ò–ú –ñ–ï –∏–ª–∏ –ë–û–õ–ï–ï –î–õ–ò–ù–ù–´–ú –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏

**–†–∞–∑—Ä–µ—à–µ–Ω–æ:**
```
Singleton  ‚Üí  Singleton  ‚úÖ
Scoped     ‚Üí  Singleton  ‚úÖ
Scoped     ‚Üí  Scoped     ‚úÖ
Transient  ‚Üí  Singleton  ‚úÖ
Transient  ‚Üí  Scoped     ‚úÖ
Transient  ‚Üí  Transient  ‚úÖ
```

**–ó–ê–ü–†–ï–©–ï–ù–û:**
```
Singleton  ‚Üí  Scoped     ‚ùå –û–®–ò–ë–ö–ê!
Singleton  ‚Üí  Transient  ‚ùå –û–®–ò–ë–ö–ê!
Scoped     ‚Üí  Transient  ‚ö†Ô∏è  –û–ø–∞—Å–Ω–æ (memory leak)
```

**–ü—Ä–∏–º–µ—Ä –û–®–ò–ë–ö–ò:**

```csharp
// ‚ùå –ü–õ–û–•–û - Singleton –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Scoped
public class CacheService // Singleton
{
    private readonly IProductRepository _repository; // Scoped
    
    public CacheService(IProductRepository repository)
    {
        _repository = repository; // –û–®–ò–ë–ö–ê –í–†–ï–ú–ï–ù–ò –í–´–ü–û–õ–ù–ï–ù–ò–Ø!
    }
}

// ASP.NET Core –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ:
// "Cannot consume scoped service 'IProductRepository' from singleton 'CacheService'"
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ - IServiceScopeFactory:**

```csharp
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
public class CacheService
{
    private readonly IServiceScopeFactory _scopeFactory;
    
    public CacheService(IServiceScopeFactory scopeFactory)
    {
        _scopeFactory = scopeFactory;
    }
    
    public async Task<Product> GetProductAsync(int id)
    {
        // –°–æ–∑–¥–∞–µ–º scope –≤—Ä—É—á–Ω—É—é
        using var scope = _scopeFactory.CreateScope();
        var repository = scope.ServiceProvider.GetRequiredService<IProductRepository>();
        
        return await repository.GetByIdAsync(id);
    }
}
```

### 5.5 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ - –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã

```csharp
var builder = WebApplication.CreateBuilder(args);

// 1. –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Üí —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
builder.Services.AddScoped<IProductService, ProductService>();

// 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ –±–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
builder.Services.AddScoped<ProductService>();

// 3. Generic —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
builder.Services.AddScoped(typeof(IRepository<>), typeof(Repository<>));

// 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å —Ñ–∞–±—Ä–∏–∫–æ–π
builder.Services.AddScoped<IMyService>(provider =>
{
    var config = provider.GetRequiredService<IConfiguration>();
    var logger = provider.GetRequiredService<ILogger<MyService>>();
    var connectionString = config.GetConnectionString("DefaultConnection");
    
    return new MyService(connectionString, logger);
});

// 5. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
if (builder.Environment.IsDevelopment())
{
    builder.Services.AddScoped<IEmailService, FakeEmailService>();
}
else
{
    builder.Services.AddScoped<IEmailService, SendGridEmailService>();
}

// 6. TryAdd - –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ
builder.Services.TryAddScoped<IProductService, ProductService>();

// 7. Replace - –∑–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
builder.Services.Replace(ServiceDescriptor.Scoped<IProductService, BetterProductService>());

// 8. RemoveAll - —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
builder.Services.RemoveAll<IProductService>();
```

### 5.6 Injection –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

**–í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö (Constructor Injection):**

```csharp
[ApiController]
[Route("api/[controller]")]
public class ProductsController : ControllerBase
{
    private readonly IProductService _productService;
    private readonly ILogger<ProductsController> _logger;
    private readonly AppSettings _settings;
    
    // –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–Ω–∂–µ–∫—Ç—è—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
    public ProductsController(
        IProductService productService,
        ILogger<ProductsController> logger,
        IOptions<AppSettings> settings)
    {
        _productService = productService;
        _logger = logger;
        _settings = settings.Value;
    }
    
    [HttpGet]
    public async Task<IActionResult> GetAllAsync()
    {
        var products = await _productService.GetAllAsync();
        return Ok(products);
    }
}
```

**–í Minimal API (Parameter Injection):**

```csharp
app.MapGet("/products", async (
    IProductService productService,
    ILogger<Program> logger) =>
{
    logger.LogInformation("Getting all products");
    var products = await productService.GetAllAsync();
    return Results.Ok(products);
});

app.MapPost("/products", async (
    Product product,
    IProductService productService,
    IValidator<Product> validator) =>
{
    var validationResult = await validator.ValidateAsync(product);
    if (!validationResult.IsValid)
    {
        return Results.ValidationProblem(validationResult.ToDictionary());
    }
    
    await productService.CreateAsync(product);
    return Results.Created($"/products/{product.Id}", product);
});
```

**–í Middleware:**

```csharp
public class RequestLoggingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<RequestLoggingMiddleware> _logger; // Singleton!
    
    // Singleton –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ
    public RequestLoggingMiddleware(
        RequestDelegate next,
        ILogger<RequestLoggingMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }
    
    // Scoped –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥–µ InvokeAsync!
    public async Task InvokeAsync(
        HttpContext context,
        IProductService productService) // Scoped - —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä –º–µ—Ç–æ–¥–∞!
    {
        _logger.LogInformation("Request: {Method} {Path}", context.Request.Method, context.Request.Path);
        
        await _next(context);
        
        _logger.LogInformation("Response: {StatusCode}", context.Response.StatusCode);
    }
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
app.UseMiddleware<RequestLoggingMiddleware>();
```

**–í BackgroundService:**

```csharp
public class OrderProcessingService : BackgroundService
{
    private readonly IServiceScopeFactory _scopeFactory; // Singleton
    private readonly ILogger<OrderProcessingService> _logger;
    
    public OrderProcessingService(
        IServiceScopeFactory scopeFactory,
        ILogger<OrderProcessingService> logger)
    {
        _scopeFactory = scopeFactory;
        _logger = logger;
    }
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                // –°–æ–∑–¥–∞–µ–º scope –¥–ª—è –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                using var scope = _scopeFactory.CreateScope();
                var orderService = scope.ServiceProvider.GetRequiredService<IOrderService>();
                
                await orderService.ProcessPendingOrdersAsync();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error processing orders");
            }
            
            await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
        }
    }
}
```

### 5.7 –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å DI

**‚ùå –û—à–∏–±–∫–∞ 1: Captive Dependency**

```csharp
// ‚ùå Singleton –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç Scoped
builder.Services.AddSingleton<CacheService>(); // Singleton
builder.Services.AddScoped<IProductRepository, ProductRepository>(); // Scoped + DbContext

public class CacheService
{
    private readonly IProductRepository _repo; // –û–®–ò–ë–ö–ê!
    
    public CacheService(IProductRepository repo)
    {
        _repo = repo; // DbContext –±—É–¥–µ—Ç –∂–∏—Ç—å –≤–µ—á–Ω–æ!
    }
}
```

**‚ùå –û—à–∏–±–∫–∞ 2: Dispose –≤—Ä—É—á–Ω—É—é**

```csharp
// ‚ùå –ù–ï –î–ï–õ–ê–ô–¢–ï –¢–ê–ö!
public class MyController : ControllerBase
{
    public IActionResult Get()
    {
        var service = new MyService();
        var result = service.DoWork();
        service.Dispose(); // DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏!
        return Ok(result);
    }
}
```

**‚ùå –û—à–∏–±–∫–∞ 3: Static –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**

```csharp
// ‚ùå –°—Ç–∞—Ç–∏–∫–∞ –Ω–∞—Ä—É—à–∞–µ—Ç DI
public class ProductService
{
    private static ILogger _logger; // –ü–õ–û–•–û!
    
    public ProductService()
    {
        _logger = LoggerFactory.Create(...); // –û–±—Ö–æ–¥–∏–º DI
    }
}
```

### 5.8 Best Practices

‚úÖ **DO:**
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏
- –ò–Ω–∂–µ–∫—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
- –î–µ–ª–∞–π—Ç–µ —Å–µ—Ä–≤–∏—Å—ã Scoped –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ IServiceScopeFactory –¥–ª—è Singleton ‚Üí Scoped
- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ DbContext –∫–∞–∫ Scoped

‚ùå **DON'T:**
- –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ `new`
- –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ Scoped –≤ Singleton
- –ù–µ –¥–µ–ª–∞–π—Ç–µ Service Locator pattern
- –ù–µ –∏–Ω–∂–µ–∫—Ç–∏—Ç–µ HttpContext –Ω–∞–ø—Ä—è–º—É—é (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ IHttpContextAccessor)
- –ù–µ Dispose —Å–µ—Ä–≤–∏—Å—ã –≤—Ä—É—á–Ω—É—é

---
# –õ–µ–∫—Ü–∏—è 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Ä–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ (–ß–∞—Å—Ç—å 2)

## 6. N-Layer Architecture (8 –º–∏–Ω—É—Ç)

### 6.1 –ö–æ–Ω—Ü–µ–ø—Ü–∏—è N-Layer Architecture

N-Layer (N-—Å–ª–æ–π–Ω–∞—è) –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ - —ç—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥ –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞, –≥–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å–ª–æ–∏ —Å —á—ë—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º–∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—è–º–∏.

**–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —Å–ª–æ—è–º (Presentation, Business, Data).

### 6.2 –¢—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–ª–æ—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Presentation Layer            ‚îÇ  ‚Üê UI, Controllers, Views
‚îÇ   (ASP.NET Core MVC/API)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Business Logic Layer          ‚îÇ  ‚Üê –°–µ—Ä–≤–∏—Å—ã, –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞
‚îÇ   (Services, Domain Models)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Data Access Layer             ‚îÇ  ‚Üê DbContext, Repositories
‚îÇ   (EF Core, SQL)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Presentation Layer (–°–ª–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è):**
- –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- Controllers, Views (MVC), API Endpoints
- ViewModels, DTOs –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
- –ó–∞–≤–∏—Å–∏—Ç –æ—Ç Business Layer

**Business Logic Layer (–°–ª–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏):**
- –°–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ –∏ –ª–æ–≥–∏–∫—É
- Services, Domain Models
- –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- –ó–∞–≤–∏—Å–∏—Ç –æ—Ç Data Access Layer

**Data Access Layer (–°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º):**
- –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- DbContext, Repositories
- Entities (–º–æ–¥–µ–ª–∏ –ë–î)
- –ú–∏–≥—Ä–∞—Ü–∏–∏
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –Ω–∏ –æ—Ç —á–µ–≥–æ (–∫—Ä–æ–º–µ EF Core)

### 6.3 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ N-Layer

```
MyApp.sln
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ MyApp.Web/                    # Presentation Layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductsController.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OrdersController.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Models/                   # ViewModels, DTOs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductViewModel.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OrderCreateDto.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ appsettings.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Program.cs
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ MyApp.Business/               # Business Logic Layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductService.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OrderService.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Interfaces/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IProductService.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ IOrderService.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Models/                   # Business Models
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OrderCalculation.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Validators/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ProductValidator.cs
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ MyApp.DataAccess/             # Data Access Layer
‚îÇ       ‚îú‚îÄ‚îÄ Data/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ApplicationDbContext.cs
‚îÇ       ‚îú‚îÄ‚îÄ Entities/                 # Database Models
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Product.cs
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Order.cs
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ OrderItem.cs
‚îÇ       ‚îú‚îÄ‚îÄ Repositories/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ProductRepository.cs
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ OrderRepository.cs
‚îÇ       ‚îî‚îÄ‚îÄ Interfaces/
‚îÇ           ‚îú‚îÄ‚îÄ IProductRepository.cs
‚îÇ           ‚îî‚îÄ‚îÄ IOrderRepository.cs
‚îÇ
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ MyApp.Tests/
```

### 6.4 –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ N-Layer

**Data Access Layer:**
```csharp
// MyApp.DataAccess/Entities/Product.cs
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public decimal Price { get; set; }
    public int CategoryId { get; set; }
    public Category Category { get; set; } = null!;
}

// MyApp.DataAccess/Data/ApplicationDbContext.cs
public class ApplicationDbContext : DbContext
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
        : base(options) { }
    
    public DbSet<Product> Products => Set<Product>();
    public DbSet<Category> Categories => Set<Category>();
}

// MyApp.DataAccess/Repositories/ProductRepository.cs
public class ProductRepository : IProductRepository
{
    private readonly ApplicationDbContext _context;
    
    public ProductRepository(ApplicationDbContext context)
    {
        _context = context;
    }
    
    public async Task<IEnumerable<Product>> GetAllAsync()
    {
        return await _context.Products
            .Include(p => p.Category)
            .ToListAsync();
    }
    
    public async Task<Product?> GetByIdAsync(int id)
    {
        return await _context.Products
            .Include(p => p.Category)
            .FirstOrDefaultAsync(p => p.Id == id);
    }
}
```

**Business Logic Layer:**
```csharp
// MyApp.Business/Services/ProductService.cs
public class ProductService : IProductService
{
    private readonly IProductRepository _repository;
    private readonly ILogger<ProductService> _logger;
    
    public ProductService(
        IProductRepository repository,
        ILogger<ProductService> logger)
    {
        _repository = repository;
        _logger = logger;
    }
    
    public async Task<IEnumerable<Product>> GetAllProductsAsync()
    {
        _logger.LogInformation("Getting all products");
        return await _repository.GetAllAsync();
    }
    
    public async Task<Product> CreateProductAsync(Product product)
    {
        // –ë–∏–∑–Ω–µ—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è
        if (product.Price < 0)
        {
            throw new BusinessException("Price cannot be negative");
        }
        
        await _repository.AddAsync(product);
        await _repository.SaveChangesAsync();
        
        _logger.LogInformation("Product created: {ProductId}", product.Id);
        return product;
    }
}
```

**Presentation Layer:**
```csharp
// MyApp.Web/Controllers/ProductsController.cs
[ApiController]
[Route("api/[controller]")]
public class ProductsController : ControllerBase
{
    private readonly IProductService _productService;
    
    public ProductsController(IProductService productService)
    {
        _productService = productService;
    }
    
    [HttpGet]
    public async Task<IActionResult> GetAll()
    {
        var products = await _productService.GetAllProductsAsync();
        return Ok(products);
    }
    
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] ProductCreateDto dto)
    {
        var product = new Product
        {
            Name = dto.Name,
            Price = dto.Price,
            CategoryId = dto.CategoryId
        };
        
        await _productService.CreateProductAsync(product);
        return CreatedAtAction(nameof(GetById), new { id = product.Id }, product);
    }
}
```

### 6.5 –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ N-Layer

**‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –ø–æ–Ω–∏–º–∞–Ω–∏—è (–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- –ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –õ–µ–≥–∫–æ –Ω–∞—á–∞—Ç—å –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
- –•–æ—Ä–æ—à–æ –∑–Ω–∞–∫–æ–º–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- –ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –¢–µ—Å–Ω–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (Business –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Data)
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –º–æ–∂–µ—Ç "–ø—Ä–æ—Ç–µ–∫–∞—Ç—å" –≤ Data Layer
- –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
- Database-first –ø–æ–¥—Ö–æ–¥ (–º–æ–¥–µ–ª–∏ –∏–∑ –ë–î –¥–∏–∫—Ç—É—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É)
- Domain Model –∑–∞–≤–∏—Å–∏—Ç –æ—Ç ORM (EF Core entities)

### 6.6 –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å N-Layer

**–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- ‚úÖ CRUD-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø—Ä–æ—Å—Ç–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π
- ‚úÖ –ù–µ–±–æ–ª—å—à–∏–µ –∏ —Å—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç—ã
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ö–æ–º–∞–Ω–¥—ã, –Ω–µ–∑–Ω–∞–∫–æ–º—ã–µ —Å DDD/Clean Architecture

**–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- ‚ùå –°–ª–æ–∂–Ω–∞—è –¥–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
- ‚ùå Enterprise-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –¥–æ–ª–≥–∏–º –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
- ‚ùå –ü—Ä–æ–µ–∫—Ç—ã, –≥–¥–µ –Ω—É–∂–Ω–∞ –≤—ã—Å–æ–∫–∞—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚ùå –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã —Å —á—ë—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º bounded contexts

---

## 7. Clean Architecture (8 –º–∏–Ω—É—Ç)

### 7.1 –§–∏–ª–æ—Å–æ—Ñ–∏—è Clean Architecture

Clean Architecture (—Ç–∞–∫–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞–∫ Onion, Hexagonal, Ports and Adapters) - —ç—Ç–æ enterprise-–ø–æ–¥—Ö–æ–¥ –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞, –≥–¥–µ **–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä–µ**, –∞ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ - –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:** –ò–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π - –≤–Ω–µ—à–Ω–∏–µ —Å–ª–æ–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö, –Ω–æ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç.

```
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   Infrastructure        ‚îÇ  ‚Üê EF Core, External APIs
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   Application           ‚îÇ  ‚Üê Use Cases, Interfaces
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   Domain                ‚îÇ  ‚Üê Entities, Business Rules
        ‚îÇ   (–Ø–î–†–û, –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å) ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.2 –ß–µ—Ç—ã—Ä–µ —Å–ª–æ—è Clean Architecture

#### Domain Layer (–Ø–¥—Ä–æ - –Ω–∏–∫–∞–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π!)

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- Entities (—Å—É—â–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏)
- Value Objects
- Domain Events
- Enums
- Domain Exceptions

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- ‚ùå –ù–ï–¢ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ (–¥–∞–∂–µ EF Core!)
- ‚ùå –ù–ï–¢ –∑–Ω–∞–Ω–∏—è –ø—Ä–æ –ë–î, UI, –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
- ‚úÖ –ß–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥

```csharp
// MyApp.Domain/Entities/Order.cs
public class Order // –ß–∏—Å—Ç–∞—è –¥–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
{
    private readonly List<OrderItem> _items = new();
    
    public int Id { get; private set; }
    public DateTime OrderDate { get; private set; }
    public OrderStatus Status { get; private set; }
    public IReadOnlyCollection<OrderItem> Items => _items.AsReadOnly();
    
    public decimal TotalAmount => _items.Sum(i => i.Subtotal);
    
    // –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ –¥–æ–º–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
    public void AddItem(Product product, int quantity)
    {
        if (quantity <= 0)
            throw new DomainException("Quantity must be positive");
        
        if (Status != OrderStatus.Draft)
            throw new DomainException("Cannot modify confirmed order");
        
        var item = new OrderItem(product, quantity);
        _items.Add(item);
    }
    
    public void Confirm()
    {
        if (!_items.Any())
            throw new DomainException("Cannot confirm empty order");
        
        Status = OrderStatus.Confirmed;
    }
}

// MyApp.Domain/ValueObjects/Money.cs
public record Money(decimal Amount, string Currency)
{
    public static Money operator +(Money a, Money b)
    {
        if (a.Currency != b.Currency)
            throw new InvalidOperationException("Cannot add different currencies");
        
        return new Money(a.Amount + b.Amount, a.Currency);
    }
}
```

#### Application Layer (–û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏)

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- Use Cases (–∫–æ–º–∞–Ω–¥—ã –∏ –∑–∞–ø—Ä–æ—Å—ã)
- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è Infrastructure
- DTOs
- Validators
- Application Services

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- ‚úÖ –ó–∞–≤–∏—Å–∏—Ç –¢–û–õ–¨–ö–û –æ—Ç Domain
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç Infrastructure
- ‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

```csharp
// MyApp.Application/Interfaces/IProductRepository.cs
public interface IProductRepository
{
    Task<Product?> GetByIdAsync(int id);
    Task<IEnumerable<Product>> GetAllAsync();
    Task AddAsync(Product product);
}

// MyApp.Application/UseCases/CreateOrder/CreateOrderCommand.cs
public record CreateOrderCommand(int CustomerId, List<OrderItemDto> Items);

public class CreateOrderCommandHandler
{
    private readonly IOrderRepository _orderRepository;
    private readonly IProductRepository _productRepository;
    private readonly IUnitOfWork _unitOfWork;
    
    public async Task<Order> Handle(CreateOrderCommand command)
    {
        var order = new Order(command.CustomerId);
        
        foreach (var itemDto in command.Items)
        {
            var product = await _productRepository.GetByIdAsync(itemDto.ProductId);
            if (product == null)
                throw new NotFoundException($"Product {itemDto.ProductId} not found");
            
            order.AddItem(product, itemDto.Quantity);
        }
        
        await _orderRepository.AddAsync(order);
        await _unitOfWork.SaveChangesAsync();
        
        return order;
    }
}
```

#### Infrastructure Layer (–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- EF Core DbContext
- –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- External API –∫–ª–∏–µ–Ω—Ç—ã
- File system access
- Email services

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- ‚úÖ –†–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏–∑ Application
- ‚úÖ –ó–∞–≤–∏—Å–∏—Ç –æ—Ç Application –∏ Domain
- ‚úÖ –ó–Ω–∞–µ—Ç –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (PostgreSQL, SendGrid, etc.)

```csharp
// MyApp.Infrastructure/Persistence/ApplicationDbContext.cs
public class ApplicationDbContext : DbContext
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
        : base(options) { }
    
    public DbSet<Order> Orders => Set<Order>();
    public DbSet<Product> Products => Set<Product>();
    
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ–º–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
        modelBuilder.Entity<Order>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.OrderDate).IsRequired();
            
            // Mapping –¥–ª—è Value Object
            entity.OwnsOne(e => e.ShippingAddress);
            
            // Private collection
            entity.HasMany(typeof(OrderItem), "_items")
                .WithOne()
                .HasForeignKey("OrderId");
        });
    }
}

// MyApp.Infrastructure/Repositories/OrderRepository.cs
public class OrderRepository : IOrderRepository
{
    private readonly ApplicationDbContext _context;
    
    public OrderRepository(ApplicationDbContext context)
    {
        _context = context;
    }
    
    public async Task<Order?> GetByIdAsync(int id)
    {
        return await _context.Orders
            .Include("_items") // Private property
            .FirstOrDefaultAsync(o => o.Id == id);
    }
    
    public async Task AddAsync(Order order)
    {
        await _context.Orders.AddAsync(order);
    }
}
```

#### Presentation Layer (Web API / UI)

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- Controllers
- API Endpoints
- Views (–µ—Å–ª–∏ MVC)
- Request/Response models

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- ‚úÖ –ó–∞–≤–∏—Å–∏—Ç –æ—Ç Application
- ‚úÖ –ù–ï –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Infrastructure –Ω–∞–ø—Ä—è–º—É—é
- ‚úÖ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```csharp
// MyApp.WebApi/Controllers/OrdersController.cs
[ApiController]
[Route("api/[controller]")]
public class OrdersController : ControllerBase
{
    private readonly IMediator _mediator; // MediatR –¥–ª—è CQRS
    
    public OrdersController(IMediator mediator)
    {
        _mediator = mediator;
    }
    
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreateOrderRequest request)
    {
        var command = new CreateOrderCommand(
            request.CustomerId,
            request.Items.Select(i => new OrderItemDto(i.ProductId, i.Quantity)).ToList()
        );
        
        var order = await _mediator.Send(command);
        
        return CreatedAtAction(nameof(GetById), new { id = order.Id }, order);
    }
}
```

### 7.3 Dependency Rule (–ü—Ä–∞–≤–∏–ª–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)

**–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ Clean Architecture:**

> –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –¢–û–õ–¨–ö–û –í–ù–£–¢–†–¨. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–ª–æ–∏ –ù–ï –ó–ù–ê–Æ–¢ –æ –≤–Ω–µ—à–Ω–∏—Ö.

```
Infrastructure ‚Üí Application ‚Üí Domain
    ‚úì              ‚úì            ‚úó
Presentation   ‚Üí Application ‚Üí Domain
    ‚úì              ‚úì            ‚úó

Domain        ‚úó‚Üí Application  # –ó–ê–ü–†–ï–©–ï–ù–û
Application   ‚úó‚Üí Infrastructure # –ó–ê–ü–†–ï–©–ï–ù–û
```

### 7.4 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ Clean Architecture

```
MyApp.sln
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ Core/                         # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–ª–æ–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MyApp.Domain/             # Domain Layer (0 –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π!)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Entities/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Order.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Product.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Customer.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ValueObjects/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Money.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Address.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Enums/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OrderStatus.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Exceptions/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ DomainException.cs
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MyApp.Application/        # Application Layer
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Interfaces/           # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è Infrastructure
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ IOrderRepository.cs
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ IEmailService.cs
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ IUnitOfWork.cs
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ UseCases/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CreateOrder/
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateOrderCommand.cs
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CreateOrderCommandHandler.cs
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ GetOrders/
‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ GetOrdersQuery.cs
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ DTOs/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ OrderDto.cs
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Validators/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ CreateOrderValidator.cs
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Infrastructure/               # –í–Ω–µ—à–Ω–∏–π —Å–ª–æ–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MyApp.Infrastructure/     # Infrastructure Layer
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Persistence/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ApplicationDbContext.cs
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Configurations/
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OrderConfiguration.cs
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ Migrations/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Repositories/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ OrderRepository.cs
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ProductRepository.cs
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ EmailService.cs
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ StorageService.cs
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Presentation/                 # –í–Ω–µ—à–Ω–∏–π —Å–ª–æ–π
‚îÇ       ‚îî‚îÄ‚îÄ MyApp.WebApi/             # Presentation Layer
‚îÇ           ‚îú‚îÄ‚îÄ Controllers/
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ OrdersController.cs
‚îÇ           ‚îú‚îÄ‚îÄ Models/               # Request/Response
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ CreateOrderRequest.cs
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ OrderResponse.cs
‚îÇ           ‚îî‚îÄ‚îÄ Program.cs
‚îÇ
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ MyApp.Domain.Tests/
    ‚îú‚îÄ‚îÄ MyApp.Application.Tests/
    ‚îî‚îÄ‚îÄ MyApp.Infrastructure.Tests/
```

### 7.5 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ Clean Architecture

```csharp
// MyApp.WebApi/Program.cs
var builder = WebApplication.CreateBuilder(args);

// Application Layer
builder.Services.AddMediatR(cfg => 
    cfg.RegisterServicesFromAssembly(typeof(CreateOrderCommand).Assembly));
builder.Services.AddValidatorsFromAssembly(typeof(CreateOrderValidator).Assembly);

// Infrastructure Layer
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseNpgsql(builder.Configuration.GetConnectionString("DefaultConnection")));

builder.Services.AddScoped<IOrderRepository, OrderRepository>();
builder.Services.AddScoped<IProductRepository, ProductRepository>();
builder.Services.AddScoped<IUnitOfWork, UnitOfWork>();
builder.Services.AddScoped<IEmailService, SendGridEmailService>();

var app = builder.Build();
```

### 7.6 –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ Clean Architecture

**‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ (Domain –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ EF Core)
- –í—ã—Å–æ–∫–∞—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å (–º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Domain –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ)
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç UI (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å API –Ω–∞ MVC –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è Domain)
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ë–î (–º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å PostgreSQL –Ω–∞ MongoDB)
- –ì–∏–±–∫–æ—Å—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
- –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å

**‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞ —Å—Ç–∞—Ä—Ç–µ (–±–æ–ª—å—à–µ –ø—Ä–æ–µ–∫—Ç–æ–≤, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤)
- Overhead –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö CRUD-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- –¢—Ä–µ–±—É–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏—è DDD –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤
- –ë–æ–ª—å—à–µ –∫–æ–¥–∞ (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –º–∞–ø–ø–µ—Ä—ã)
- –ö—Ä—É—Ç–∞—è –∫—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥—ã

### 7.7 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ N-Layer vs Clean Architecture

| –ê—Å–ø–µ–∫—Ç | N-Layer | Clean Architecture |
|--------|---------|-------------------|
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | –ü—Ä–æ—Å—Ç–∞—è | –°–ª–æ–∂–Ω–∞—è |
| **–ö—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è** | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è |
| **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** | –°–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ | –í–Ω—É—Ç—Ä—å (–∏–Ω–≤–µ—Ä—Å–∏—è) |
| **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è |
| **–ì–∏–±–∫–æ—Å—Ç—å** | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è |
| **–†–∞–∑–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞** | –ú–∞–ª—ã–π/–°—Ä–µ–¥–Ω–∏–π | –°—Ä–µ–¥–Ω–∏–π/–ë–æ–ª—å—à–æ–π |
| **Domain –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å** | ‚ùå | ‚úÖ |
| **–ó–∞–º–µ–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã** | –°–ª–æ–∂–Ω–æ | –õ–µ–≥–∫–æ |
| **Overhead** | –ù–∏–∑–∫–∏–π | –í—ã—Å–æ–∫–∏–π |
| **–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è** | CRUD, –ø—Ä–æ—Ç–æ—Ç–∏–ø—ã | Enterprise, DDD |

### 7.8 –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Clean Architecture

**–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- ‚úÖ Enterprise-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –¥–æ–ª–≥–∏–º –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
- ‚úÖ –°–ª–æ–∂–Ω–∞—è –¥–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
- ‚úÖ –ü—Ä–æ–µ–∫—Ç—ã, –≥–¥–µ –≤–∞–∂–Ω–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã —Å —á–µ—Ç–∫–∏–º–∏ bounded contexts
- ‚úÖ –ö–æ–º–∞–Ω–¥—ã, –∑–Ω–∞–∫–æ–º—ã–µ —Å DDD

**–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- ‚ùå –ü—Ä–æ—Å—Ç—ã–µ CRUD-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚ùå –ü—Ä–æ—Ç–æ—Ç–∏–ø—ã –∏ MVP
- ‚ùå –ù–µ–±–æ–ª—å—à–∏–µ –ø—Ä–æ–µ–∫—Ç—ã —Å –ø—Ä–æ—Å—Ç–æ–π –ª–æ–≥–∏–∫–æ–π
- ‚ùå –ö–æ–º–∞–Ω–¥—ã –±–µ–∑ –æ–ø—ã—Ç–∞ –≤ DDD
- ‚ùå –ü—Ä–æ–µ–∫—Ç—ã —Å –∂–µ—Å—Ç–∫–∏–º–∏ –¥–µ–¥–ª–∞–π–Ω–∞–º–∏

---

## 8. Entity Framework Core: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (8 –º–∏–Ω—É—Ç)

### 8.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤

```bash
# –í –ø—Ä–æ–µ–∫—Ç–µ Infrastructure/DataAccess
dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL --version 8.0.10
```

**–í–∞–∂–Ω–æ:** –í–µ—Ä—Å–∏—è Npgsql.EntityFrameworkCore.PostgreSQL –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏–∏ .NET:
- .NET 8 ‚Üí Npgsql 8.x
- .NET 9 ‚Üí Npgsql 9.x

### 8.2 –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π (Entities)

```csharp
// Product.cs
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public decimal Price { get; set; }
    public int Stock { get; set; }
    public int CategoryId { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
    
    // Navigation properties
    public Category Category { get; set; } = null!;
    public ICollection<OrderItem> OrderItems { get; set; } = new List<OrderItem>();
}

// Category.cs
public class Category
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    
    public ICollection<Product> Products { get; set; } = new List<Product>();
}

// Order.cs
public class Order
{
    public int Id { get; set; }
    public DateTime OrderDate { get; set; }
    public int CustomerId { get; set; }
    public decimal TotalAmount { get; set; }
    public OrderStatus Status { get; set; }
    
    public Customer Customer { get; set; } = null!;
    public ICollection<OrderItem> Items { get; set; } = new List<OrderItem>();
}

// OrderItem.cs
public class OrderItem
{
    public int Id { get; set; }
    public int OrderId { get; set; }
    public int ProductId { get; set; }
    public int Quantity { get; set; }
    public decimal UnitPrice { get; set; }
    
    public Order Order { get; set; } = null!;
    public Product Product { get; set; } = null!;
}

public enum OrderStatus
{
    Pending,
    Confirmed,
    Shipped,
    Delivered,
    Cancelled
}
```

### 8.3 –°–æ–∑–¥–∞–Ω–∏–µ DbContext

```csharp
public class ApplicationDbContext : DbContext
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
        : base(options)
    {
    }
    
    // DbSet properties
    public DbSet<Product> Products => Set<Product>();
    public DbSet<Category> Categories => Set<Category>();
    public DbSet<Order> Orders => Set<Order>();
    public DbSet<OrderItem> OrderItems => Set<OrderItem>();
    public DbSet<Customer> Customers => Set<Customer>();
    
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏–∑ —Å–±–æ—Ä–∫–∏
        modelBuilder.ApplyConfigurationsFromAssembly(typeof(ApplicationDbContext).Assembly);
        
        // –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ inline
        ConfigureProduct(modelBuilder);
        ConfigureOrder(modelBuilder);
    }
    
    private void ConfigureProduct(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<Product>(entity =>
        {
            entity.ToTable("products");
            
            entity.HasKey(e => e.Id);
            
            entity.Property(e => e.Name)
                .HasMaxLength(200)
                .IsRequired();
            
            entity.Property(e => e.Description)
                .HasMaxLength(1000);
            
            entity.Property(e => e.Price)
                .HasColumnType("decimal(18,2)")
                .IsRequired();
            
            entity.Property(e => e.CreatedAt)
                .HasDefaultValueSql("CURRENT_TIMESTAMP");
            
            // –ò–Ω–¥–µ–∫—Å—ã
            entity.HasIndex(e => e.Name);
            entity.HasIndex(e => e.CategoryId);
            
            // –°–≤—è–∑–∏
            entity.HasOne(e => e.Category)
                .WithMany(c => c.Products)
                .HasForeignKey(e => e.CategoryId)
                .OnDelete(DeleteBehavior.Restrict);
        });
    }
    
    private void ConfigureOrder(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<Order>(entity =>
        {
            entity.ToTable("orders");
            
            entity.HasKey(e => e.Id);
            
            entity.Property(e => e.TotalAmount)
                .HasColumnType("decimal(18,2)");
            
            entity.Property(e => e.Status)
                .HasConversion<string>(); // Enum ‚Üí —Å—Ç—Ä–æ–∫–∞ –≤ –ë–î
            
            entity.HasMany(e => e.Items)
                .WithOne(i => i.Order)
                .HasForeignKey(i => i.OrderId)
                .OnDelete(DeleteBehavior.Cascade);
        });
    }
}
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –æ—Ç–¥–µ–ª—å–Ω—ã–µ Configuration –∫–ª–∞—Å—Å—ã:**

```csharp
// ProductConfiguration.cs
public class ProductConfiguration : IEntityTypeConfiguration<Product>
{
    public void Configure(EntityTypeBuilder<Product> builder)
    {
        builder.ToTable("products");
        
        builder.HasKey(e => e.Id);
        
        builder.Property(e => e.Name)
            .HasMaxLength(200)
            .IsRequired();
        
        builder.Property(e => e.Price)
            .HasColumnType("decimal(18,2)");
        
        builder.HasOne(e => e.Category)
            .WithMany(c => c.Products)
            .HasForeignKey(e => e.CategoryId);
    }
}

// –í OnModelCreating:
modelBuilder.ApplyConfiguration(new ProductConfiguration());
```

### 8.4 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è DbContext —á–µ—Ä–µ–∑ DI

```csharp
// Program.cs
var builder = WebApplication.CreateBuilder(args);

// –ë–∞–∑–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseNpgsql(
        builder.Configuration.GetConnectionString("DefaultConnection")));

// –° –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
builder.Services.AddDbContext<ApplicationDbContext>(options =>
{
    options.UseNpgsql(
        builder.Configuration.GetConnectionString("DefaultConnection"),
        npgsqlOptions =>
        {
            // –¢–∞–π–º–∞—É—Ç—ã
            npgsqlOptions.CommandTimeout(30);
            
            // Retry policy
            npgsqlOptions.EnableRetryOnFailure(
                maxRetryCount: 3,
                maxRetryDelay: TimeSpan.FromSeconds(30),
                errorCodesToAdd: null);
            
            // –í–µ—Ä—Å–∏—è PostgreSQL
            npgsqlOptions.SetPostgresVersion(new Version(16, 0));
        });
    
    // –¢–æ–ª—å–∫–æ –¥–ª—è Development
    if (builder.Environment.IsDevelopment())
    {
        options.EnableSensitiveDataLogging(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö
        options.EnableDetailedErrors(); // –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
        options.LogTo(Console.WriteLine, LogLevel.Information);
    }
});
```

---

## 9. DbContext Factory (5 –º–∏–Ω—É—Ç)

### 9.1 –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ IDbContextFactory

**–ü—Ä–æ–±–ª–µ–º–∞:** Scoped DbContext –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:
- Background Services (Singleton)
- Parallel operations
- –î–ª–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –≤ –æ–¥–Ω–æ–º scope

**–†–µ—à–µ–Ω–∏–µ:** IDbContextFactory<TContext>

### 9.2 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```csharp
// Program.cs - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ–∞–±—Ä–∏–∫–∏
builder.Services.AddDbContextFactory<ApplicationDbContext>(options =>
    options.UseNpgsql(
        builder.Configuration.GetConnectionString("DefaultConnection")));
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Background Service:**

```csharp
public class DataProcessingService : BackgroundService
{
    private readonly IDbContextFactory<ApplicationDbContext> _contextFactory;
    private readonly ILogger<DataProcessingService> _logger;
    
    public DataProcessingService(
        IDbContextFactory<ApplicationDbContext> contextFactory,
        ILogger<DataProcessingService> logger)
    {
        _contextFactory = contextFactory;
        _logger = logger;
    }
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                await using var context = await _contextFactory.CreateDbContextAsync(stoppingToken);
                
                var pendingOrders = await context.Orders
                    .Where(o => o.Status == OrderStatus.Pending)
                    .ToListAsync(stoppingToken);
                
                foreach (var order in pendingOrders)
                {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–∞
                    _logger.LogInformation("Processing order {OrderId}", order.Id);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error processing data");
            }
            
            await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
        }
    }
}
```

**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:**

```csharp
public class BulkOperationService
{
    private readonly IDbContextFactory<ApplicationDbContext> _contextFactory;
    
    public async Task ProcessItemsInParallelAsync(List<int> itemIds)
    {
        var tasks = itemIds.Select(async id =>
        {
            // –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π DbContext
            await using var context = await _contextFactory.CreateDbContextAsync();
            
            var item = await context.Items.FindAsync(id);
            if (item != null)
            {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞...
                await context.SaveChangesAsync();
            }
        });
        
        await Task.WhenAll(tasks);
    }
}
```

### 9.3 DbContext Factory vs Scoped DbContext

| –ê—Å–ø–µ–∫—Ç | Scoped DbContext | DbContext Factory |
|--------|-----------------|-------------------|
| **Lifetime** | Scoped (–æ–¥–∏–Ω –Ω–∞ –∑–∞–ø—Ä–æ—Å) | Transient (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ) |
| **Use case** | HTTP –∑–∞–ø—Ä–æ—Å—ã, Web APIs | Background services, parallel ops |
| **Disposal** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π | –í—Ä—É—á–Ω—É—é (using/await using) |
| **Performance** | ‚ö°‚ö°‚ö° (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) | ‚ö°‚ö° (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑) |
| **–ö–æ–≥–¥–∞** | 95% —Å–ª—É—á–∞–µ–≤ | –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ |


# –õ–µ–∫—Ü–∏—è 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Ä–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ (–ß–∞—Å—Ç—å 3)

## 10. FluentMigrator: –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑ –∫–æ–¥–∞ (10 –º–∏–Ω—É—Ç)

### 10.1 –ß—Ç–æ —Ç–∞–∫–æ–µ FluentMigrator –∏ –∑–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω

**FluentMigrator** - —ç—Ç–æ framework –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Fluent API –Ω–∞ C#.

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç EF Core (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å Dapper, ADO.NET)
- ‚úÖ –ë–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ SQL
- ‚úÖ –ù–µ –Ω—É–∂–Ω—ã –∫–æ–º–∞–Ω–¥—ã `dotnet ef`
- ‚úÖ Code-first –ø–æ–¥—Ö–æ–¥ –∫ –º–∏–≥—Ä–∞—Ü–∏—è–º
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –ë–î (PostgreSQL, SQL Server, MySQL, SQLite)

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å EF Core Migrations:**

| –ê—Å–ø–µ–∫—Ç | EF Core Migrations | FluentMigrator |
|--------|-------------------|----------------|
| **–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫** | ‚ùå –ù—É–∂–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç EF** | ‚úÖ –ù—É–∂–µ–Ω EF Core | ‚ùå –ù–µ –Ω—É–∂–µ–Ω |
| **–ö–æ–Ω—Ç—Ä–æ–ª—å SQL** | –°—Ä–µ–¥–Ω–∏–π | –í—ã—Å–æ–∫–∏–π |
| **–°–∏–Ω—Ç–∞–∫—Å–∏—Å** | Generated code | Fluent API |
| **ORM –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å** | ‚ùå | ‚úÖ |

### 10.2 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤

```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
dotnet add package FluentMigrator
dotnet add package FluentMigrator.Runner
dotnet add package FluentMigrator.Runner.Postgres

# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
dotnet add package FluentMigrator.Extensions.Postgres
```

### 10.3 –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:**

```csharp
using FluentMigrator;

namespace MyApp.Infrastructure.Migrations
{
    // –ê—Ç—Ä–∏–±—É—Ç Migration —Å –£–ù–ò–ö–ê–õ–¨–ù–´–ú –Ω–æ–º–µ—Ä–æ–º –≤–µ—Ä—Å–∏–∏
    // –§–æ—Ä–º–∞—Ç: YYYYMMDDHHMMSS (–≥–æ–¥, –º–µ—Å—è—Ü, –¥–µ–Ω—å, —á–∞—Å, –º–∏–Ω—É—Ç–∞, —Å–µ–∫—É–Ω–¥–∞)
    [Migration(20250121120000)]
    public class InitialMigration : Migration
    {
        // –ú–µ—Ç–æ–¥ Up - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
        public override void Up()
        {
            // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü, –∏–Ω–¥–µ–∫—Å–æ–≤, –∏ —Ç.–¥.
        }
        
        // –ú–µ—Ç–æ–¥ Down - –æ—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
        public override void Down()
        {
            // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –≤ Up
        }
    }
}
```

**–ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:**

```csharp
[Migration(20250121120000)]
public class InitialMigration : Migration
{
    public override void Up()
    {
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã Categories
        Create.Table("categories")
            .WithColumn("id").AsInt32().PrimaryKey().Identity()
            .WithColumn("name").AsString(200).NotNullable()
            .WithColumn("description").AsString(1000).Nullable()
            .WithColumn("created_at").AsDateTime().NotNullable()
                .WithDefault(SystemMethods.CurrentDateTime);
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã Products
        Create.Table("products")
            .WithColumn("id").AsInt32().PrimaryKey().Identity()
            .WithColumn("name").AsString(200).NotNullable()
            .WithColumn("description").AsString(1000).Nullable()
            .WithColumn("price").AsDecimal(18, 2).NotNullable()
            .WithColumn("stock").AsInt32().NotNullable().WithDefaultValue(0)
            .WithColumn("category_id").AsInt32().NotNullable()
            .WithColumn("created_at").AsDateTime().NotNullable()
                .WithDefault(SystemMethods.CurrentDateTime)
            .WithColumn("updated_at").AsDateTime().Nullable();
        
        // –í–Ω–µ—à–Ω–∏–π –∫–ª—é—á
        Create.ForeignKey("fk_products_category")
            .FromTable("products").ForeignColumn("category_id")
            .ToTable("categories").PrimaryColumn("id")
            .OnDelete(System.Data.Rule.Restrict);
        
        // –ò–Ω–¥–µ–∫—Å—ã
        Create.Index("idx_products_category")
            .OnTable("products")
            .OnColumn("category_id");
        
        Create.Index("idx_products_name")
            .OnTable("products")
            .OnColumn("name");
        
        // Unique constraint
        Create.UniqueConstraint("uq_categories_name")
            .OnTable("categories")
            .Column("name");
    }
    
    public override void Down()
    {
        // –£–¥–∞–ª–µ–Ω–∏–µ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        Delete.Table("products");
        Delete.Table("categories");
    }
}
```

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫:**

```csharp
[Migration(20250121130000)]
public class AddProductIsActiveColumn : Migration
{
    public override void Up()
    {
        Alter.Table("products")
            .AddColumn("is_active").AsBoolean()
                .NotNullable()
                .WithDefaultValue(true);
    }
    
    public override void Down()
    {
        Delete.Column("is_active").FromTable("products");
    }
}
```

**–í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (seeding):**

```csharp
[Migration(20250121140000)]
public class SeedInitialData : Migration
{
    public override void Up()
    {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        Insert.IntoTable("categories")
            .Row(new
            {
                name = "Electronics",
                description = "Electronic devices and accessories",
                created_at = DateTime.UtcNow
            })
            .Row(new
            {
                name = "Books",
                description = "Books and publications",
                created_at = DateTime.UtcNow
            });
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        Insert.IntoTable("products")
            .Row(new
            {
                name = "Laptop",
                description = "High-performance laptop",
                price = 999.99m,
                stock = 10,
                category_id = 1,
                created_at = DateTime.UtcNow
            });
    }
    
    public override void Down()
    {
        Delete.FromTable("products").AllRows();
        Delete.FromTable("categories").AllRows();
    }
}
```

**–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –Ω–∞–ø—Ä—è–º—É—é:**

```csharp
[Migration(20250121150000)]
public class AddCustomFunction : Migration
{
    public override void Up()
    {
        Execute.Sql(@"
            CREATE OR REPLACE FUNCTION calculate_order_total(order_id INT)
            RETURNS DECIMAL(18,2) AS $$
            BEGIN
                RETURN (
                    SELECT SUM(unit_price * quantity)
                    FROM order_items
                    WHERE order_id = $1
                );
            END;
            $$ LANGUAGE plpgsql;
        ");
    }
    
    public override void Down()
    {
        Execute.Sql("DROP FUNCTION IF EXISTS calculate_order_total(INT);");
    }
}
```

### 10.4 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ FluentMigrator

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Program.cs:**

```csharp
using FluentMigrator.Runner;

var builder = WebApplication.CreateBuilder(args);

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è FluentMigrator
builder.Services.AddFluentMigratorCore()
    .ConfigureRunner(rb => rb
        // –í—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ë–î
        .AddPostgres()
        // Connection string
        .WithGlobalConnectionString(
            builder.Configuration.GetConnectionString("DefaultConnection"))
        // –ì–¥–µ –∏—Å–∫–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
        .ScanIn(typeof(Program).Assembly).For.Migrations())
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    .AddLogging(lb => lb.AddFluentMigratorConsole());

var app = builder.Build();

// –ö–†–ò–¢–ò–ß–ù–û: –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
using (var scope = app.Services.CreateScope())
{
    var runner = scope.ServiceProvider.GetRequiredService<IMigrationRunner>();
    
    if (app.Environment.IsDevelopment())
    {
        // –í Development –≤—Å–µ–≥–¥–∞ –º–∏–≥—Ä–∏—Ä—É–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
        runner.MigrateUp();
    }
    else
    {
        // –í Production –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
        try
        {
            runner.MigrateUp();
        }
        catch (Exception ex)
        {
            var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();
            logger.LogError(ex, "Migration failed");
            throw; // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å
        }
    }
}

app.Run();
```

**–í–∞—Ä–∏–∞–Ω—Ç —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ endpoint:**

```csharp
// –î–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
app.MapPost("/admin/migrate", async (IMigrationRunner runner) =>
{
    try
    {
        runner.MigrateUp();
        return Results.Ok(new { message = "Migrations applied successfully" });
    }
    catch (Exception ex)
    {
        return Results.Problem(
            detail: ex.Message,
            title: "Migration failed"
        );
    }
})
.RequireAuthorization("AdminOnly"); // –ó–∞—â–∏—Ç–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π!
```

### 10.5 –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã FluentMigrator

```csharp
// –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
runner.MigrateUp();

// –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏
runner.MigrateUp(20250121120000);

// –û—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
runner.MigrateDown(0);

// –û—Ç–∫–∞—Ç –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏
runner.MigrateDown(20250121120000);

// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö
runner.ListMigrations();
```

### 10.6 Best Practices –¥–ª—è FluentMigrator

‚úÖ **DO:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ timestamp —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –Ω–æ–º–µ—Ä–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π: `YYYYMMDDHHMMSS`
- –í—Å–µ–≥–¥–∞ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –º–µ—Ç–æ–¥ `Down()` –¥–ª—è –æ—Ç–∫–∞—Ç–∞
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–æ–ø–∏–∏ production –ë–î
- –î–µ–ª–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –∏ –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏
- –•—Ä–∞–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Git
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

‚ùå **DON'T:**
- –ù–µ –∏–∑–º–µ–Ω—è–π—Ç–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ –≤–µ—Ä—Å–∏–π
- –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è FK
- –ù–µ –¥–µ–ª–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–Ω–∏–º–∞—é—Ç —á–∞—Å—ã

### 10.7 –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫:**

```
MyApp.Infrastructure/
‚îú‚îÄ‚îÄ Migrations/
‚îÇ   ‚îú‚îÄ‚îÄ _20250121_Initial/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 20250121120000_InitialMigration.cs
‚îÇ   ‚îú‚îÄ‚îÄ _20250122_Products/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20250122100000_AddProductTable.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 20250122110000_AddProductIndexes.cs
‚îÇ   ‚îî‚îÄ‚îÄ _20250123_Orders/
‚îÇ       ‚îî‚îÄ‚îÄ 20250123090000_AddOrderTables.cs
```

---

## 11. –°–≤—è–∑–∏ –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏ –≤ EF Core (5 –º–∏–Ω—É—Ç)

### 11.1 One-to-Many (1:N)

**–ü—Ä–∏–º–µ—Ä: –û–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí –º–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤**

```csharp
public class Category
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    
    // Navigation property (–∫–æ–ª–ª–µ–∫—Ü–∏—è)
    public ICollection<Product> Products { get; set; } = new List<Product>();
}

public class Product
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    
    // Foreign Key
    public int CategoryId { get; set; }
    
    // Navigation property (—Å—Å—ã–ª–∫–∞)
    public Category Category { get; set; } = null!;
}
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**

```csharp
modelBuilder.Entity<Product>()
    .HasOne(p => p.Category)           // –£ Product –µ—Å—Ç—å –æ–¥–Ω–∞ Category
    .WithMany(c => c.Products)         // –£ Category –º–Ω–æ–≥–æ Products
    .HasForeignKey(p => p.CategoryId)  // FK - CategoryId
    .OnDelete(DeleteBehavior.Restrict); // –ó–∞–ø—Ä–µ—Ç —É–¥–∞–ª–µ–Ω–∏—è Category —Å Products
```

**–í–∞—Ä–∏–∞–Ω—Ç—ã DeleteBehavior:**
- `Restrict` - –ó–∞–ø—Ä–µ—â–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ (–≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ)
- `Cascade` - –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (—É–¥–∞–ª–∏—Ç –≤—Å–µ Products)
- `SetNull` - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç FK –≤ NULL
- `NoAction` - –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å (–ë–î —Ä–µ—à–∏—Ç —Å–∞–º–∞)

### 11.2 One-to-One (1:1)

**–ü—Ä–∏–º–µ—Ä: –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –æ–¥–∏–Ω –ø—Ä–æ—Ñ–∏–ª—å**

```csharp
public class User
{
    public int Id { get; set; }
    public string Email { get; set; } = string.Empty;
    
    // Navigation property
    public UserProfile? Profile { get; set; }
}

public class UserProfile
{
    public int Id { get; set; }
    
    // Foreign Key (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤ dependent entity)
    public int UserId { get; set; }
    
    public string FirstName { get; set; } = string.Empty;
    public string LastName { get; set; } = string.Empty;
    public DateTime DateOfBirth { get; set; }
    
    // Navigation property
    public User User { get; set; } = null!;
}
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**

```csharp
modelBuilder.Entity<User>()
    .HasOne(u => u.Profile)              // –£ User –µ—Å—Ç—å –æ–¥–∏–Ω Profile
    .WithOne(p => p.User)                // –£ Profile –µ—Å—Ç—å –æ–¥–∏–Ω User
    .HasForeignKey<UserProfile>(p => p.UserId); // FK –≤ UserProfile
```

### 11.3 Many-to-Many (N:M)

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è join table (EF Core 5.0+)**

```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    
    // Navigation property - –∫–æ–ª–ª–µ–∫—Ü–∏—è
    public ICollection<Tag> Tags { get; set; } = new List<Tag>();
}

public class Tag
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    
    // Navigation property - –∫–æ–ª–ª–µ–∫—Ü–∏—è
    public ICollection<Product> Products { get; set; } = new List<Product>();
}
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**

```csharp
modelBuilder.Entity<Product>()
    .HasMany(p => p.Tags)
    .WithMany(t => t.Products);
    // EF Core –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É ProductTag
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –Ø–≤–Ω–∞—è join table (–±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è)**

```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    
    // –ß–µ—Ä–µ–∑ join entity
    public ICollection<ProductTag> ProductTags { get; set; } = new List<ProductTag>();
}

public class Tag
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    
    // –ß–µ—Ä–µ–∑ join entity
    public ICollection<ProductTag> ProductTags { get; set; } = new List<ProductTag>();
}

// Join entity —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
public class ProductTag
{
    public int ProductId { get; set; }
    public Product Product { get; set; } = null!;
    
    public int TagId { get; set; }
    public Tag Tag { get; set; } = null!;
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    public DateTime AssignedAt { get; set; }
    public string AssignedBy { get; set; } = string.Empty;
}
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**

```csharp
modelBuilder.Entity<ProductTag>(entity =>
{
    // Composite primary key
    entity.HasKey(pt => new { pt.ProductId, pt.TagId });
    
    entity.HasOne(pt => pt.Product)
        .WithMany(p => p.ProductTags)
        .HasForeignKey(pt => pt.ProductId);
    
    entity.HasOne(pt => pt.Tag)
        .WithMany(t => t.ProductTags)
        .HasForeignKey(pt => pt.TagId);
});
```

---

## 12. Repository Pattern: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (10 –º–∏–Ω—É—Ç)

### 12.1 –ü–æ—á–µ–º—É Generic Repository - –ê–ù–¢–ò–ü–ê–¢–¢–ï–†–ù

**Generic Repository –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:**

```csharp
// ‚ùå –≠–¢–û –ê–ù–¢–ò–ü–ê–¢–¢–ï–†–ù!
public interface IRepository<T> where T : class
{
    Task<T?> GetByIdAsync(int id);
    Task<IEnumerable<T>> GetAllAsync();
    Task<IEnumerable<T>> FindAsync(Expression<Func<T, bool>> predicate);
    Task AddAsync(T entity);
    Task AddRangeAsync(IEnumerable<T> entities);
    void Update(T entity);
    void Delete(T entity);
    Task<int> SaveChangesAsync();
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø–ª–æ—Ö–æ:**

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**
   - DbContext –∏ DbSet<T> –£–ñ–ï –Ø–í–õ–Ø–Æ–¢–°–Ø Repository –∏ Unit of Work
   - –í—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –µ—â—ë –æ–¥–∏–Ω —Å–ª–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –ø–æ–≤–µ—Ä—Ö –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏

2. **–°–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ EF Core**
   ```csharp
   // ‚ùå –¢–µ—Ä—è–µ–º Include, AsNoTracking, –∏ –¥—Ä—É–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
   var products = await repository.GetAllAsync();
   
   // ‚úÖ –° DbContext –Ω–∞–ø—Ä—è–º—É—é
   var products = await context.Products
       .Include(p => p.Category)
       .AsNoTracking()
       .Where(p => p.IsActive)
       .OrderBy(p => p.Name)
       .ToListAsync();
   ```

3. **Expression<Func<T, bool>> - –∫–æ—à–º–∞—Ä –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**
   ```csharp
   // –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–º–æ–∫–∞—Ç—å —ç—Ç–æ!
   var products = await repository.FindAsync(p => 
       p.Category.Name == "Electronics" && 
       p.Price > 100);
   ```

4. **–ù–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø YAGNI (You Aren't Gonna Need It)**
   - 95% –º–µ—Ç–æ–¥–æ–≤ Generic Repository –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
   - –ù–æ –≤—ã –≤—ã–Ω—É–∂–¥–µ–Ω—ã –∏—Ö —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å

5. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–∏–∑–Ω–µ—Å-—Å–º—ã—Å–ª–∞**
   ```csharp
   // ‚ùå –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç?
   var items = await repository.FindAsync(x => x.Something);
   
   // ‚úÖ –ù–∞–º–Ω–æ–≥–æ –ø–æ–Ω—è—Ç–Ω–µ–µ
   var activeProducts = await productRepo.GetActiveProductsAsync();
   ```

### 12.2 –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: Specific Repositories

**–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¢–û–õ–¨–ö–û –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏:**

```csharp
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
public interface IProductRepository
{
    // –¢–æ–ª—å–∫–æ –º–µ—Ç–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω—ã
    Task<Product?> GetByIdWithCategoryAsync(int id);
    Task<IEnumerable<Product>> GetActiveProductsAsync();
    Task<IEnumerable<Product>> GetProductsByCategoryAsync(int categoryId);
    Task<IEnumerable<Product>> GetLowStockProductsAsync(int threshold);
    Task<PagedResult<Product>> SearchProductsAsync(string searchTerm, int page, int pageSize);
    Task<bool> IsProductNameUniqueAsync(string name, int? excludeId = null);
}
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```csharp
public class ProductRepository : IProductRepository
{
    private readonly ApplicationDbContext _context;
    
    public ProductRepository(ApplicationDbContext context)
    {
        _context = context;
    }
    
    public async Task<Product?> GetByIdWithCategoryAsync(int id)
    {
        return await _context.Products
            .Include(p => p.Category)
            .AsNoTracking()
            .FirstOrDefaultAsync(p => p.Id == id);
    }
    
    public async Task<IEnumerable<Product>> GetActiveProductsAsync()
    {
        return await _context.Products
            .Where(p => p.IsActive && p.Stock > 0)
            .Include(p => p.Category)
            .OrderBy(p => p.Name)
            .AsNoTracking()
            .ToListAsync();
    }
    
    public async Task<IEnumerable<Product>> GetProductsByCategoryAsync(int categoryId)
    {
        return await _context.Products
            .Where(p => p.CategoryId == categoryId && p.IsActive)
            .Include(p => p.Category)
            .OrderBy(p => p.Name)
            .AsNoTracking()
            .ToListAsync();
    }
    
    public async Task<IEnumerable<Product>> GetLowStockProductsAsync(int threshold)
    {
        return await _context.Products
            .Where(p => p.IsActive && p.Stock <= threshold)
            .Include(p => p.Category)
            .OrderBy(p => p.Stock)
            .AsNoTracking()
            .ToListAsync();
    }
    
    public async Task<PagedResult<Product>> SearchProductsAsync(
        string searchTerm, int page, int pageSize)
    {
        var query = _context.Products
            .Where(p => p.IsActive && 
                (p.Name.Contains(searchTerm) || p.Description.Contains(searchTerm)))
            .Include(p => p.Category)
            .AsNoTracking();
        
        var totalCount = await query.CountAsync();
        
        var items = await query
            .Skip((page - 1) * pageSize)
            .Take(pageSize)
            .ToListAsync();
        
        return new PagedResult<Product>
        {
            Items = items,
            TotalCount = totalCount,
            Page = page,
            PageSize = pageSize
        };
    }
    
    public async Task<bool> IsProductNameUniqueAsync(string name, int? excludeId = null)
    {
        var query = _context.Products.Where(p => p.Name == name);
        
        if (excludeId.HasValue)
        {
            query = query.Where(p => p.Id != excludeId.Value);
        }
        
        return !await query.AnyAsync();
    }
}
```

### 12.3 –ö–æ–≥–¥–∞ –ù–ï –Ω—É–∂–µ–Ω Repository

**–î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö CRUD –æ–ø–µ—Ä–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ DbContext –Ω–∞–ø—Ä—è–º—É—é:**

```csharp
public class CategoryService
{
    private readonly ApplicationDbContext _context;
    
    public CategoryService(ApplicationDbContext context)
    {
        _context = context;
    }
    
    // –ü—Ä–æ—Å—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ - –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ DbContext
    public async Task<Category?> GetByIdAsync(int id)
    {
        return await _context.Categories.FindAsync(id);
    }
    
    public async Task<List<Category>> GetAllAsync()
    {
        return await _context.Categories
            .OrderBy(c => c.Name)
            .ToListAsync();
    }
    
    public async Task<Category> CreateAsync(Category category)
    {
        _context.Categories.Add(category);
        await _context.SaveChangesAsync();
        return category;
    }
    
    public async Task UpdateAsync(Category category)
    {
        _context.Categories.Update(category);
        await _context.SaveChangesAsync();
    }
    
    public async Task DeleteAsync(int id)
    {
        var category = await _context.Categories.FindAsync(id);
        if (category != null)
        {
            _context.Categories.Remove(category);
            await _context.SaveChangesAsync();
        }
    }
}
```

### 12.4 –†–µ—à–µ–Ω–∏–µ: –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Repository

**‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Repository –∫–æ–≥–¥–∞:**
- –°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
- –ù—É–∂–Ω–∞ –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π –ª–æ–≥–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- –ó–∞–ø—Ä–æ—Å—ã —Å –±–∏–∑–Ω–µ—Å-—Å–º—ã—Å–ª–æ–º (`GetActiveProducts`, `GetOverdueOrders`)
- –ù—É–∂–Ω–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —Å–º–µ–Ω—ã –ë–î

**‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Repository –∫–æ–≥–¥–∞:**
- –ü—Ä–æ—Å—Ç—ã–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ó–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –ù–µ—Ç —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
- –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ DbContext

---

## 13. Unit of Work Pattern (8 –º–∏–Ω—É—Ç)

### 13.1 –ö–æ–Ω—Ü–µ–ø—Ü–∏—è Unit of Work

**Unit of Work** –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å.

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω:**
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å (–≤—Å—ë –∏–ª–∏ –Ω–∏—á–µ–≥–æ)
- –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—ã–∑–æ–≤–∞ SaveChanges
- Explicit transactions

### 13.2 –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Unit of Work

```csharp
public interface IUnitOfWork : IDisposable
{
    // –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
    IProductRepository Products { get; }
    IOrderRepository Orders { get; }
    ICustomerRepository Customers { get; }
    
    // –ú–µ—Ç–æ–¥—ã
    Task<int> SaveChangesAsync(CancellationToken cancellationToken = default);
    Task BeginTransactionAsync();
    Task CommitTransactionAsync();
    Task RollbackTransactionAsync();
}

public class UnitOfWork : IUnitOfWork
{
    private readonly ApplicationDbContext _context;
    private IDbContextTransaction? _transaction;
    
    // Lazy initialization —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
    private IProductRepository? _productRepository;
    private IOrderRepository? _orderRepository;
    private ICustomerRepository? _customerRepository;
    
    public UnitOfWork(ApplicationDbContext context)
    {
        _context = context;
    }
    
    public IProductRepository Products
    {
        get
        {
            _productRepository ??= new ProductRepository(_context);
            return _productRepository;
        }
    }
    
    public IOrderRepository Orders
    {
        get
        {
            _orderRepository ??= new OrderRepository(_context);
            return _orderRepository;
        }
    }
    
    public ICustomerRepository Customers
    {
        get
        {
            _customerRepository ??= new CustomerRepository(_context);
            return _customerRepository;
        }
    }
    
    public async Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
    {
        return await _context.SaveChangesAsync(cancellationToken);
    }
    
    public async Task BeginTransactionAsync()
    {
        _transaction = await _context.Database.BeginTransactionAsync();
    }
    
    public async Task CommitTransactionAsync()
    {
        try
        {
            await SaveChangesAsync();
            
            if (_transaction != null)
            {
                await _transaction.CommitAsync();
            }
        }
        catch
        {
            await RollbackTransactionAsync();
            throw;
        }
        finally
        {
            if (_transaction != null)
            {
                await _transaction.DisposeAsync();
                _transaction = null;
            }
        }
    }
    
    public async Task RollbackTransactionAsync()
    {
        if (_transaction != null)
        {
            await _transaction.RollbackAsync();
            await _transaction.DisposeAsync();
            _transaction = null;
        }
    }
    
    public void Dispose()
    {
        _transaction?.Dispose();
        _context.Dispose();
    }
}
```

### 13.3 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Unit of Work

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**

```csharp
builder.Services.AddScoped<IUnitOfWork, UnitOfWork>();
```

**–í —Å–µ—Ä–≤–∏—Å–µ:**

```csharp
public class OrderService
{
    private readonly IUnitOfWork _unitOfWork;
    private readonly ILogger<OrderService> _logger;
    
    public OrderService(IUnitOfWork unitOfWork, ILogger<OrderService> logger)
    {
        _unitOfWork = unitOfWork;
        _logger = logger;
    }
    
    public async Task<Order> CreateOrderAsync(CreateOrderDto dto)
    {
        await _unitOfWork.BeginTransactionAsync();
        
        try
        {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞
            var customer = await _unitOfWork.Customers.GetByIdAsync(dto.CustomerId);
            if (customer == null)
            {
                throw new NotFoundException("Customer not found");
            }
            
            // 2. –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑
            var order = new Order
            {
                CustomerId = dto.CustomerId,
                OrderDate = DateTime.UtcNow,
                Status = OrderStatus.Pending
            };
            
            await _unitOfWork.Orders.AddAsync(order);
            
            // 3. –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞
            decimal totalAmount = 0;
            
            foreach (var itemDto in dto.Items)
            {
                var product = await _unitOfWork.Products.GetByIdAsync(itemDto.ProductId);
                if (product == null)
                {
                    throw new NotFoundException($"Product {itemDto.ProductId} not found");
                }
                
                if (product.Stock < itemDto.Quantity)
                {
                    throw new BusinessException(
                        $"Insufficient stock for product {product.Name}");
                }
                
                // –£–º–µ–Ω—å—à–∞–µ–º –∑–∞–ø–∞—Å—ã
                product.Stock -= itemDto.Quantity;
                await _unitOfWork.Products.UpdateAsync(product);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∑–∞–∫–∞–∑–∞
                var orderItem = new OrderItem
                {
                    Order = order,
                    ProductId = product.Id,
                    Quantity = itemDto.Quantity,
                    UnitPrice = product.Price
                };
                
                await _unitOfWork.Orders.AddItemAsync(orderItem);
                totalAmount += orderItem.UnitPrice * orderItem.Quantity;
            }
            
            order.TotalAmount = totalAmount;
            
            // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            await _unitOfWork.CommitTransactionAsync();
            
            _logger.LogInformation("Order {OrderId} created for customer {CustomerId}",
                order.Id, customer.Id);
            
            return order;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error creating order for customer {CustomerId}",
                dto.CustomerId);
            await _unitOfWork.RollbackTransactionAsync();
            throw;
        }
    }
}
```

### 13.4 –ö–æ–≥–¥–∞ –ù–ï –Ω—É–∂–µ–Ω Unit of Work

**DbContext —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è Unit of Work:**

```csharp
public class SimpleOrderService
{
    private readonly ApplicationDbContext _context;
    
    public async Task CreateSimpleOrderAsync(Order order)
    {
        // DbContext —É–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
        _context.Orders.Add(order);
        
        // SaveChanges –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        await _context.SaveChangesAsync();
        // ‚úÖ –í—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏!
    }
}
```

**Unit of Work –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è:**
- Explicit transactions (BeginTransaction)
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- –°–ª–æ–∂–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏

---

## 14. –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ (7 –º–∏–Ω—É—Ç)

### 14.1 Best Practices ‚úÖ

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```csharp
// ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
public class ProductsController : ControllerBase
{
    private readonly IProductService _service; // –ù–ï DbContext!
    
    [HttpGet]
    public async Task<IActionResult> GetAll()
    {
        var products = await _service.GetAllAsync();
        return Ok(products);
    }
}
```

**EF Core:**
```csharp
// ‚úÖ –í—Å–µ–≥–¥–∞ async
public async Task<List<Product>> GetAllAsync()
{
    return await _context.Products.ToListAsync();
}

// ‚úÖ AsNoTracking –¥–ª—è read-only
public async Task<IEnumerable<Product>> GetProductsAsync()
{
    return await _context.Products
        .AsNoTracking() // –ù–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        .ToListAsync();
}

// ‚úÖ Include –¥–ª—è eager loading
public async Task<Product?> GetByIdAsync(int id)
{
    return await _context.Products
        .Include(p => p.Category)
        .Include(p => p.OrderItems)
        .FirstOrDefaultAsync(p => p.Id == id);
}
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```csharp
// ‚úÖ Secrets –≤ User Secrets (dev) –∏ Env Variables (prod)
// ‚úÖ Options Pattern –¥–ª—è strongly-typed –Ω–∞—Å—Ç—Ä–æ–µ–∫
public class MyService
{
    private readonly AppSettings _settings;
    
    public MyService(IOptions<AppSettings> options)
    {
        _settings = options.Value;
    }
}
```

### 14.2 –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ ‚ùå

**–û—à–∏–±–∫–∞ 1: DbContext –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ**
```csharp
// ‚ùå –ü–õ–û–•–û
public class ProductsController : ControllerBase
{
    private readonly ApplicationDbContext _context;
    
    [HttpGet]
    public async Task<IActionResult> Get()
    {
        return Ok(await _context.Products.ToListAsync());
    }
}

// ‚úÖ –•–û–†–û–®–û
public class ProductsController : ControllerBase
{
    private readonly IProductService _productService;
    
    [HttpGet]
    public async Task<IActionResult> Get()
    {
        var products = await _productService.GetAllAsync();
        return Ok(products);
    }
}
```

**–û—à–∏–±–∫–∞ 2: N+1 Problem**
```csharp
// ‚ùå –ü–õ–û–•–û - N+1 –∑–∞–ø—Ä–æ—Å–æ–≤
var products = await _context.Products.ToListAsync();
foreach (var product in products)
{
    var category = await _context.Categories.FindAsync(product.CategoryId);
    // –ö–∞–∂–¥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è = –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å!
}

// ‚úÖ –•–û–†–û–®–û - 1 –∑–∞–ø—Ä–æ—Å
var products = await _context.Products
    .Include(p => p.Category)
    .ToListAsync();
```

**–û—à–∏–±–∫–∞ 3: –ó–∞–±—ã—Ç—ã–π AsNoTracking**
```csharp
// ‚ùå –ü–õ–û–•–û - tracking –¥–ª—è read-only
public async Task<IEnumerable<Product>> GetAllAsync()
{
    return await _context.Products.ToListAsync();
    // EF Core –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (overhead)
}

// ‚úÖ –•–û–†–û–®–û
public async Task<IEnumerable<Product>> GetAllAsync()
{
    return await _context.Products
        .AsNoTracking()
        .ToListAsync();
}
```

**–û—à–∏–±–∫–∞ 4: –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã**
```csharp
// ‚ùå –ü–õ–û–•–û - –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫
public List<Product> GetAll()
{
    return _context.Products.ToList();
}

// ‚úÖ –•–û–†–û–®–û - async/await
public async Task<List<Product>> GetAllAsync()
{
    return await _context.Products.ToListAsync();
}
```

**–û—à–∏–±–∫–∞ 5: –í–æ–∑–≤—Ä–∞—Ç Entity –∏–∑ API**
```csharp
// ‚ùå –ü–õ–û–•–û - —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏, over-fetching
[HttpGet("{id}")]
public async Task<Product> Get(int id)
{
    return await _context.Products
        .Include(p => p.Category)
        .FirstAsync(p => p.Id == id);
}

// ‚úÖ –•–û–†–û–®–û - DTO
[HttpGet("{id}")]
public async Task<ProductDto> Get(int id)
{
    var product = await _context.Products
        .Include(p => p.Category)
        .FirstAsync(p => p.Id == id);
    
    return new ProductDto
    {
        Id = product.Id,
        Name = product.Name,
        Price = product.Price,
        CategoryName = product.Category.Name
    };
}
```

**–û—à–∏–±–∫–∞ 6: Generic Repository**
```csharp
// ‚ùå –ê–ù–¢–ò–ü–ê–¢–¢–ï–†–ù
public interface IRepository<T> where T : class
{
    Task<IEnumerable<T>> GetAllAsync();
    Task<T> GetByIdAsync(int id);
    // ...
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - Specific Repository
public interface IProductRepository
{
    Task<Product?> GetByIdWithCategoryAsync(int id);
    Task<IEnumerable<Product>> GetActiveProductsAsync();
}
```

### 14.3 Performance Tips

```csharp
// ‚úÖ –ü—Ä–æ–µ–∫—Ü–∏—è –ø–æ–ª–µ–π (Select)
var products = await _context.Products
    .Select(p => new { p.Id, p.Name, p.Price })
    .ToListAsync();

// ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è
var products = await _context.Products
    .Skip((page - 1) * pageSize)
    .Take(pageSize)
    .ToListAsync();

// ‚úÖ AsSplitQuery –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö Include
var orders = await _context.Orders
    .Include(o => o.Items)
    .Include(o => o.Customer)
    .AsSplitQuery() // –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤
    .ToListAsync();

// ‚úÖ Compiled Queries –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
private static readonly Func<ApplicationDbContext, int, Task<Product?>> 
    GetProductById = EF.CompileAsyncQuery(
        (ApplicationDbContext context, int id) =>
            context.Products.FirstOrDefault(p => p.Id == id));
```

### 14.4 –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] Connection strings –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- [ ] –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ —Ä–∞–±–æ—Ç—ã —Å –ë–î
- [ ] AsNoTracking –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è read-only
- [ ] Sensitive data logging –≤—ã–∫–ª—é—á–µ–Ω –≤ production
- [ ] DTO –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–º–µ—Å—Ç–æ Entity –≤ API
- [ ] –°–µ—Ä–≤–∏—Å—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º lifetime
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- [ ] –ù–µ—Ç Generic Repository
- [ ] DbContext –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö

---

## 15. –†–µ–∑—é–º–µ

### –ß—Ç–æ –º—ã –∏–∑—É—á–∏–ª–∏

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (10 –º–∏–Ω):**
- –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ASP.NET Core
- Options Pattern –¥–ª—è strongly-typed –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤

**Dependency Injection (12 –º–∏–Ω):**
- –í—Ä–µ–º–µ–Ω–∞ –∂–∏–∑–Ω–∏: Singleton, Scoped, Transient
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
- –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ best practices

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (16 –º–∏–Ω):**
- N-Layer: –ø—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- Clean Architecture: enterprise —Ä–µ—à–µ–Ω–∏–µ
- Dependency Rule –∏ –∏–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ (23 –º–∏–Ω):**
- PostgreSQL –≤ Docker
- EF Core: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞, DbContext, —Å–≤—è–∑–∏
- DbContext Factory
- FluentMigrator: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

**–ü–∞—Ç—Ç–µ—Ä–Ω—ã (18 –º–∏–Ω):**
- –ü–æ—á–µ–º—É Generic Repository - –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω
- Specific Repository –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Unit of Work –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

### –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
2. **Generic Repository - –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω**, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Specific
3. **DbContext —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è Repository –∏ Unit of Work**
4. **–í—Å–µ–≥–¥–∞ async/await** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
5. **AsNoTracking** –¥–ª—è read-only –æ–ø–µ—Ä–∞—Ü–∏–π
6. **Options Pattern** –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
7. **User Secrets** –≤ dev, **Environment Variables** –≤ prod
8. **FluentMigrator** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- **Microsoft Docs:** https://learn.microsoft.com/en-us/aspnet/core/
- **Clean Architecture:** https://github.com/jasontaylordev/CleanArchitecture
- **EF Core Performance:** https://learn.microsoft.com/en-us/ef/core/performance/
- **FluentMigrator:** https://fluentmigrator.github.io/

---
